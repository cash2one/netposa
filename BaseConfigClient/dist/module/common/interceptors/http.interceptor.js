define(["require", "exports", "../app/main.app", "angular", "es6-promise", "../factory/userinfo.cache.factory", "../factory/response.notify.factory"], function (require, exports, main_app_1) {
    "use strict";
    Object.defineProperty(exports, "__esModule", { value: true });
    var Promise = require("es6-promise");
    var HttpInterceptor = (function () {
        function HttpInterceptor(userInfoCacheFactory, notifyFactory, $q) {
            this.userInfoCacheFactory = userInfoCacheFactory;
            this.notifyFactory = notifyFactory;
            this.$q = $q;
            this._LOADING_CACHE_MAP = {};
            var vm = this;
            this.request = _request;
            this.requestError = _requestError;
            this.response = _response;
            this.responseError = _responseError;
            function _request(config) {
                if (isIgnore(config))
                    return config;
                var headerConfig = config.headers;
                var headers = userInfoCacheFactory.getCurrentUserKey();
                var header;
                for (header in headers) {
                    headerConfig[header] = headers[header];
                }
                headers = userInfoCacheFactory.getCurrentUserIDMap();
                for (header in headers) {
                    headerConfig[header] = headers[header];
                }
                if (!config.cancel) {
                    var cancel = $q.defer();
                    config.cancel = cancel;
                    config.timeout = cancel.promise;
                }
                if (config.showLoad) {
                    toggleLayerLoad(getUrl(config));
                    delete config.showLoad;
                }
                return config;
            }
            function _requestError(err) {
                if (isIgnore(err.config) || isSaveLog(err.config))
                    return Promise.reject(err);
                console.debug("http.interceptor._requestError", err);
                toggleLayerLoad(getUrl(err.config), true);
            }
            function _response(res) {
                if (isIgnore(res.config) || isSaveLog(res.config))
                    return res;
                console.debug("http.interceptor._response", res);
                toggleLayerLoad(getUrl(res.config), true);
                vm.notifyFactory.msg({ onlyError: true })(res.data);
                return res.data;
            }
            function _responseError(err) {
                if (isIgnore(err.config) || isSaveLog(err.config))
                    return Promise.reject(err);
                console.debug("Http.interceptor._responseError", err);
                toggleLayerLoad(getUrl(err.config), true);
                vm.notifyFactory.msg({ onlyError: true, codeKey: 'status' })(err);
                return Promise.reject(err);
            }
            function isIgnore(httpConfig) {
                if (!httpConfig) {
                    console.warn("interceptor.isIgnore httpConfig Error, httpConfig is null!");
                }
                var _url = getUrl(httpConfig);
                var isStart_db = ("/db" == _url.slice(0, 3));
                var isStart_fds = ("/pdp" == _url.slice(0, 4));
                var isStart_bcs = ("/bcs" == _url.slice(0, 4));
                return !(isStart_db || isStart_fds || isStart_bcs);
            }
            function isSaveLog(httpConfig) {
                if (!httpConfig) {
                    console.warn("interceptor.isIgnore httpConfig Error, httpConfig is null!");
                }
                var _url = getUrl(httpConfig);
                var isLogUrl = ('/db/systemlog' == _url.slice(0, 13));
                if (isLogUrl) {
                    return true;
                }
                else {
                    return false;
                }
            }
            function getUrl(httpConfig) {
                if (!httpConfig) {
                    console.warn("interceptor.getUrl httpConfig Error, httpConfig is null!");
                }
                return httpConfig.url;
            }
            function toggleLayerLoad(url, isClose) {
                if (!url) {
                    console.warn("interceptor.toggleLoading url Error, url is null!");
                }
                if (vm._LOADING_CACHE_MAP[url] && isClose) {
                    layer.close(vm._LOADING_CACHE_MAP[url]);
                    delete vm._LOADING_CACHE_MAP[url];
                }
                else if (!isClose) {
                    vm._LOADING_CACHE_MAP[url] = layer.load(3);
                }
            }
        }
        HttpInterceptor.$inject = ['userInfoCacheFactory', 'notifyFactory', '$q'];
        return HttpInterceptor;
    }());
    main_app_1.app.service('httpInterceptor', HttpInterceptor);
});

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNyYy9tb2R1bGUvY29tbW9uL2ludGVyY2VwdG9ycy9odHRwLmludGVyY2VwdG9yLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztJQWFBLElBQUksT0FBTyxHQUFHLE9BQU8sQ0FBQyxhQUFhLENBQUMsQ0FBQztJQUVyQztRQVFJLHlCQUFvQixvQkFBMkMsRUFBVSxhQUFxQyxFQUFVLEVBQU87WUFBM0cseUJBQW9CLEdBQXBCLG9CQUFvQixDQUF1QjtZQUFVLGtCQUFhLEdBQWIsYUFBYSxDQUF3QjtZQUFVLE9BQUUsR0FBRixFQUFFLENBQUs7WUFGdkgsdUJBQWtCLEdBQUcsRUFBK0IsQ0FBQztZQUd6RCxJQUFJLEVBQUUsR0FBRyxJQUFJLENBQUM7WUFDZCxJQUFJLENBQUMsT0FBTyxHQUFHLFFBQVEsQ0FBQztZQUN4QixJQUFJLENBQUMsWUFBWSxHQUFHLGFBQWEsQ0FBQztZQUNsQyxJQUFJLENBQUMsUUFBUSxHQUFHLFNBQVMsQ0FBQztZQUMxQixJQUFJLENBQUMsYUFBYSxHQUFHLGNBQWMsQ0FBQztZQUVwQyxrQkFBa0IsTUFBVztnQkFDekIsRUFBRSxDQUFDLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFDO29CQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUM7Z0JBR3BDLElBQUksWUFBWSxHQUFHLE1BQU0sQ0FBQyxPQUFPLENBQUM7Z0JBQ2xDLElBQUksT0FBTyxHQUFHLG9CQUFvQixDQUFDLGlCQUFpQixFQUFFLENBQUM7Z0JBQ3ZELElBQUksTUFBTSxDQUFDO2dCQUNYLEdBQUcsQ0FBQyxDQUFDLE1BQU0sSUFBSSxPQUFPLENBQUMsQ0FBQyxDQUFDO29CQUNyQixZQUFZLENBQUMsTUFBTSxDQUFDLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDO2dCQUMzQyxDQUFDO2dCQUNELE9BQU8sR0FBRyxvQkFBb0IsQ0FBQyxtQkFBbUIsRUFBRSxDQUFDO2dCQUNyRCxHQUFHLENBQUMsQ0FBQyxNQUFNLElBQUksT0FBTyxDQUFDLENBQUMs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QUFFLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7b0JBQ1AsT0FBTyxDQUFDLElBQUksQ0FBQyxtREFBbUQsQ0FBQyxDQUFDO2dCQUN0RSxDQUFDO2dCQUNELEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxrQkFBa0IsQ0FBQyxHQUFHLENBQUMsSUFBSSxPQUFPLENBQUMsQ0FBQyxDQUFDO29CQUV4QyxLQUFLLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxrQkFBa0IsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO29CQUN4QyxPQUFPLEVBQUUsQ0FBQyxrQkFBa0IsQ0FBQyxHQUFHLENBQUMsQ0FBQztnQkFDdEMsQ0FBQztnQkFBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO29CQUVsQixFQUFFLENBQUMsa0JBQWtCLENBQUMsR0FBRyxDQUFDLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDL0MsQ0FBQztZQUVMLENBQUM7UUFDTCxDQUFDO1FBeEpNLHVCQUFPLEdBQUcsQ0FBQyxzQkFBc0IsRUFBRSxlQUFlLEVBQUUsSUFBSSxDQUFDLENBQUM7UUF5SnJFLHNCQUFDO0tBMUpELEFBMEpDLElBQUE7SUFFRCxjQUFHLENBQUMsT0FBTyxDQUFDLGlCQUFpQixFQUFFLGVBQWUsQ0FBQyxDQUFDIiwiZmlsZSI6Im1vZHVsZS9jb21tb24vaW50ZXJjZXB0b3JzL2h0dHAuaW50ZXJjZXB0b3IuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBhcHAgfSBmcm9tICcuLi9hcHAvbWFpbi5hcHAnO1xyXG5pbXBvcnQgJ2FuZ3VsYXInO1xyXG5pbXBvcnQgXCJlczYtcHJvbWlzZVwiO1xyXG5pbXBvcnQgeyBJVXNlckluZm9DYWNoZUZhY3RvcnkgfSBmcm9tIFwiLi4vZmFjdG9yeS91c2VyaW5mby5jYWNoZS5mYWN0b3J5XCI7XHJcbmltcG9ydCBcIi4uL2ZhY3RvcnkvdXNlcmluZm8uY2FjaGUuZmFjdG9yeVwiO1xyXG5pbXBvcnQgeyBIdHRwUmVzcG9uc2VSZXN1bHQgfSBmcm9tIFwiLi4vLi4vLi4vY29yZS9wYXJhbXMvcmVzdWx0L1Jlc3BvbnNlUmVzdWx0XCI7XHJcbmltcG9ydCBcIi4uL2ZhY3RvcnkvcmVzcG9uc2Uubm90aWZ5LmZhY3RvcnlcIjtcclxuaW1wb3J0IHsgSVJlc3BvbnNlTm90aWZ5RmFjdG9yeSB9IGZyb20gXCIuLi9mYWN0b3J5L3Jlc3BvbnNlLm5vdGlmeS5mYWN0b3J5XCI7XHJcbmltcG9ydCBDb25maWcgZnJvbSBcIi4uLy4uLy4uL2NvbmZpZ1wiO1xyXG5pbXBvcnQgeyBJUG9ydHJhaXRSZXF1ZXN0Q29uZmlnIH0gZnJvbSBcIi4vaHR0cFwiO1xyXG5kZWNsYXJlIGxldCByZXF1aXJlOiBhbnk7XHJcbmRlY2xhcmUgbGV0IGFuZ3VsYXI6IGFueTtcclxuZGVjbGFyZSBsZXQgbGF5ZXI6IGFueTtcclxubGV0IFByb21pc2UgPSByZXF1aXJlKFwiZXM2LXByb21pc2VcIik7XHJcblxyXG5jbGFzcyBIdHRwSW50ZXJjZXB0b3Ige1xyXG4gICAgc3RhdGljICRpbmplY3QgPSBbJ3VzZXJJbmZvQ2FjaGVGYWN0b3J5JywgJ25vdGlmeUZhY3RvcnknLCAnJHEnXTtcclxuICAgIHJlcXVlc3Q6IEZ1bmN0aW9uO1xyXG4gICAgcmVxdWVzdEVycm9yOiBGdW5jdGlvbjtcclxuICAgIHJlc3BvbnNlOiBGdW5jdGlvbjtcclxuICAgIHJlc3BvbnNlRXJyb3I6IEZ1bmN0aW9uO1xyXG4gICAgcHJpdmF0ZSBfTE9BRElOR19DQUNIRV9NQVAgPSB7fSBhcyB7IFtrZXk6IHN0cmluZ106IG51bWJlciB9O1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgdXNlckluZm9DYWNoZUZhY3Rvcnk6IElVc2VySW5mb0NhY2hlRmFjdG9yeSwgcHJpdmF0ZSBub3RpZnlGYWN0b3J5OiBJUmVzcG9uc2VOb3RpZnlGYWN0b3J5LCBwcml2YXRlICRxOiBhbnkpIHtcclxuICAgICAgICBsZXQgdm0gPSB0aGlzO1xyXG4gICAgICAgIHRoaXMucmVxdWVzdCA9IF9yZXF1ZXN0O1xyXG4gICAgICAgIHRoaXMucmVxdWVzdEVycm9yID0gX3JlcXVlc3RFcnJvcjtcclxuICAgICAgICB0aGlzLnJlc3BvbnNlID0gX3Jlc3BvbnNlO1xyXG4gICAgICAgIHRoaXMucmVzcG9uc2VFcnJvciA9IF9yZXNwb25zZUVycm9yO1xyXG5cclxuICAgICAgICBmdW5jdGlvbiBfcmVxdWVzdChjb25maWc6IGFueSkge1xyXG4gICAgICAgICAgICBpZiAoaXNJZ25vcmUoY29uZmlnKSkgcmV0dXJuIGNvbmZpZztcclxuICAgICAgICAgICAgLy8gYWxlcnQgd3lyIDIwMTcuNi45IOa3u+WKoCB0b2tlbiDlj4LmlbBcclxuXHJcbiAgICAgICAgICAgIGxldCBoZWFkZXJDb25maWcgPSBjb25maWcuaGVhZGVycztcclxuICAgICAgICAgICAgbGV0IGhlYWRlcnMgPSB1c2VySW5mb0NhY2hlRmFjdG9yeS5nZXRDdXJyZW50VXNlcktleSgpO1xyXG4gICAgICAgICAgICBsZXQgaGVhZGVyO1xyXG4gICAgICAgICAgICBmb3IgKGhlYWRlciBpbiBoZWFkZXJzKSB7XHJcbiAgICAgICAgICAgICAgICBoZWFkZXJDb25maWdbaGVhZGVyXSA9IGhlYWRlcnNbaGVhZGVyXTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBoZWFkZXJzID0gdXNlckluZm9DYWNoZUZhY3RvcnkuZ2V0Q3VycmVudFVzZXJJRE1hcCgpO1xyXG4gICAgICAgICAgICBmb3IgKGhlYWRlciBpbiBoZWFkZXJzKSB7XHJcbiAgICAgICAgICAgICAgICBoZWFkZXJDb25maWdbaGVhZGVyXSA9IGhlYWRlcnNbaGVhZGVyXTtcclxuICAgICAgICAgICAgfVxyXG5cclxuXHJcbiAgICAgICAgICAgIC8vIC8vIOWinuWKoOWFqOWxgOi2heaXtuaXtumXtFxyXG4gICAgICAgICAgICAvLyBpZiAoIWNvbmZpZy50aW1lb3V0KSB7XHJcbiAgICAgICAgICAgIC8vICAgICBjb25maWcudGltZW91dCA9IENvbmZpZy5HTE9CQUxfVElNRV9PVVQ7XHJcbiAgICAgICAgICAgIC8vIH1cclxuXHJcbiAgICAgICAgICAgIC8vIOmFjee9ruaJi+WKqGNhbmNlbFxyXG4gICAgICAgICAgICBpZiAoIWNvbmZpZy5jYW5jZWwpIHtcclxuICAgICAgICAgICAgICAgIGxldCBjYW5jZWwgPSAkcS5kZWZlcigpO1xyXG4gICAgICAgICAgICAgICAgY29uZmlnLmNhbmNlbCA9IGNhbmNlbDtcclxuICAgICAgICAgICAgICAgIGNvbmZpZy50aW1lb3V0ID0gY2FuY2VsLnByb21pc2U7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIC8vIOWinuWKoOWFqOWxgOmBrue9qVxyXG4gICAgICAgICAgICBpZiAoY29uZmlnLnNob3dMb2FkKSB7XHJcbiAgICAgICAgICAgICAgICB0b2dnbGVMYXllckxvYWQoZ2V0VXJsKGNvbmZpZykpO1xyXG4gICAgICAgICAgICAgICAgLy8g5Zyo6L+Z6YeM5riF6Zmk5o6Jc2hvd0xvYWTphY3nva4sIOS4jeWwhuatpOmFjee9ruWPkemAgee7meWQjuWPsFxyXG4gICAgICAgICAgICAgICAgZGVsZXRlIGNvbmZpZy5zaG93TG9hZDtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgcmV0dXJuIGNvbmZpZztcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGZ1bmN0aW9uIF9yZXF1ZXN0RXJyb3IoZXJyOiBhbnkpIHtcclxuICAgICAgICAgICAgaWYgKGlzSWdub3JlKGVyci5jb25maWcpIHx8IGlzU2F2ZUxvZyhlcnIuY29uZmlnKSkgcmV0dXJuIFByb21pc2UucmVqZWN0KGVycik7XHJcbiAgICAgICAgICAgIGNvbnNvbGUuZGVidWcoXCJodHRwLmludGVyY2VwdG9yLl9yZXF1ZXN0RXJyb3JcIiwgZXJyKTtcclxuICAgICAgICAgICAgdG9nZ2xlTGF5ZXJMb2FkKGdldFVybChlcnIuY29uZmlnKSwgdHJ1ZSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBmdW5jdGlvbiBfcmVzcG9uc2UocmVzOiBIdHRwUmVzcG9uc2VSZXN1bHQ8YW55Pikge1xyXG4gICAgICAgICAgICBpZiAoaXNJZ25vcmUocmVzLmNvbmZpZykgfHwgaXNTYXZlTG9nKHJlcy5jb25maWcpKSByZXR1cm4gcmVzO1xyXG4gICAgICAgICAgICBjb25zb2xlLmRlYnVnKFwiaHR0cC5pbnRlcmNlcHRvci5fcmVzcG9uc2VcIiwgcmVzKTtcclxuICAgICAgICAgICAgLy9UT0RPICDlj5HpgIHor7fmsYLlkI4g5byC5bi46YCA5Ye6IOi/lOWbnui3s+W+gOeZu+W9lSDmnKrlgZrjgILjgILjgILjgIJcclxuICAgICAgICAgICAgLy8gaWYocmVzLmRhdGEgJiYgcmVzLmRhdGEuQ29kZSE9MjAwKXtcclxuICAgICAgICAgICAgLy8gICAgIGxheWVyLm1zZyhg5ZCO5Y+w6L+U5Zue54q25oCB56CB44CC44CC44CC44CCPC9icj4gJHsgcmVzLmRhdGEuQ29kZSB9IDwvYnI+IOaOpeWPo++8miAke3Jlcy5jb25maWcudXJsfTwvYnI+6ZyA6KaB55qE5pe25YCZ5re75Yqg55u45bqU6YC76L6R44CC44CC44CC44CCYCk7XHJcbiAgICAgICAgICAgIC8vIH1cclxuICAgICAgICAgICAgdG9nZ2xlTGF5ZXJMb2FkKGdldFVybChyZXMuY29uZmlnKSwgdHJ1ZSk7XHJcbiAgICAgICAgICAgIHZtLm5vdGlmeUZhY3RvcnkubXNnKHsgb25seUVycm9yOiB0cnVlIH0pKHJlcy5kYXRhKTtcclxuICAgICAgICAgICAgcmV0dXJuIHJlcy5kYXRhO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgZnVuY3Rpb24gX3Jlc3BvbnNlRXJyb3IoZXJyOiBhbnkpIHtcclxuICAgICAgICAgICAgaWYgKGlzSWdub3JlKGVyci5jb25maWcpIHx8IGlzU2F2ZUxvZyhlcnIuY29uZmlnKSkgcmV0dXJuIFByb21pc2UucmVqZWN0KGVycik7XHJcbiAgICAgICAgICAgIGNvbnNvbGUuZGVidWcoXCJIdHRwLmludGVyY2VwdG9yLl9yZXNwb25zZUVycm9yXCIsIGVycik7XHJcbiAgICAgICAgICAgIC8vIGVyci5zdGF0dXNcclxuICAgICAgICAgICAgLy8gMO+8muWuouaIt+erryDorr7nva7otoXml7Yg5Li75YqoIOaWreW8gOivt+axgumTvuaOpeOAgSDmsqHnvZFcclxuICAgICAgICAgICAgLy8gNTA077ya5pyN5Yqh5Zmo5pat5byAIOaXoOe9kee7nFxyXG4gICAgICAgICAgICAvLyBpZigtMSA9PT0gZXJyLnN0YXR1cykge1xyXG4gICAgICAgICAgICAvLyAgICAgLy8g6L+c56iL5pyN5Yqh5Zmo5peg5ZON5bqUXHJcbiAgICAgICAgICAgIC8vIH0gZWxzZSBpZig1MDAgPT09IGVyci5zdGF0dXMpIHtcclxuICAgICAgICAgICAgLy8gICAgIC8vIOWkhOeQhuWQhOexu+iHquWumuS5iemUmeivr1xyXG4gICAgICAgICAgICAvLyB9IGVsc2UgaWYoNTAxID09PSBlcnIuc3RhdHVzKSB7XHJcbiAgICAgICAgICAgIC8vICAgICAvLyAuLi5cclxuICAgICAgICAgICAgLy8gfSBlbHNlIGlmKDAgPT09IGVyci5zdGF0dXMpIHtcclxuICAgICAgICAgICAgLy8gICAgIGNvbnNvbGUubG9nKFwiJWMgPT09PT3or7fmsYLotoXml7YgMTBz44CC44CC44CC44CCPT09PT09PT09PT09PT1cIixcImNvbG9yOm9yYW5nZVwiKTtcclxuICAgICAgICAgICAgLy8gfVxyXG4gICAgICAgICAgICB0b2dnbGVMYXllckxvYWQoZ2V0VXJsKGVyci5jb25maWcpLCB0cnVlKTtcclxuICAgICAgICAgICAgLy8gVE9ETyDpkojlr7nov5nnp43nnJ/lrp7nmoRodHRw6K+35rGCLCDlvLnlh7rnmoTplJnor6/mj5DnpLrmmoLml7bov5jmsqHlrposIOi/mOmcgOS/ruaUuSByZXNvbHZlOiB3eXJcclxuICAgICAgICAgICAgdm0ubm90aWZ5RmFjdG9yeS5tc2coeyBvbmx5RXJyb3I6IHRydWUsIGNvZGVLZXk6ICdzdGF0dXMnIH0pKGVycik7XHJcbiAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdChlcnIpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8g5b+955Wl6L+H5ruk55qE5oum5oiqXHJcbiAgICAgICAgZnVuY3Rpb24gaXNJZ25vcmUoaHR0cENvbmZpZzogYW55KTogYm9vbGVhbiB7XHJcbiAgICAgICAgICAgIGlmICghaHR0cENvbmZpZykge1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS53YXJuKFwiaW50ZXJjZXB0b3IuaXNJZ25vcmUgaHR0cENvbmZpZyBFcnJvciwgaHR0cENvbmZpZyBpcyBudWxsIVwiKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBsZXQgX3VybCA9IGdldFVybChodHRwQ29uZmlnKTtcclxuXHJcbiAgICAgICAgICAgIC8v6L+H5rukIOaJgOaciSB1cmwg5LiN5pivXCIvZGJcIiDlvIDlpLTnmoQg6K+35rGCXHJcbiAgICAgICAgICAgIGxldCBpc1N0YXJ0X2RiID0gKFwiL2RiXCIgPT0gX3VybC5zbGljZSgwLCAzKSk7XHJcbiAgICAgICAgICAgIGxldCBpc1N0YXJ0X2ZkcyA9IChcIi9wZHBcIiA9PSBfdXJsLnNsaWNlKDAsIDQpKTtcclxuICAgICAgICAgICAgbGV0IGlzU3RhcnRfYmNzID0gKFwiL2Jjc1wiID09IF91cmwuc2xpY2UoMCwgNCkpO1xyXG4gICAgICAgICAgICByZXR1cm4gIShpc1N0YXJ0X2RiIHx8IGlzU3RhcnRfZmRzIHx8IGlzU3RhcnRfYmNzKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8qKlxyXG4gICAgICAgICAqIOeUseS6juWinuWKoOS6huaXpeW/l+iusOW9lSwg5omA5Lul5pel5b+X6K6w5b2V5pON5L2c55qE5oiQ5Yqf5oiW6ICF5aSx6LSl6YO95LiN5Lya5by55Ye65o+Q56S65L+h5oGvLCDovpPlhaXpnZnpu5jor7fmsYLlkozov5Tlm55cclxuICAgICAgICAgKiBAcGFyYW0gaHR0cENvbmZpZ1xyXG4gICAgICAgICAqIEByZXR1cm4ge2Jvb2xlYW59XHJcbiAgICAgICAgICovXHJcbiAgICAgICAgZnVuY3Rpb24gaXNTYXZlTG9nKGh0dHBDb25maWc6IElQb3J0cmFpdFJlcXVlc3RDb25maWcpOiBib29sZWFuIHtcclxuICAgICAgICAgICAgaWYgKCFodHRwQ29uZmlnKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oXCJpbnRlcmNlcHRvci5pc0lnbm9yZSBodHRwQ29uZmlnIEVycm9yLCBodHRwQ29uZmlnIGlzIG51bGwhXCIpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHZhciBfdXJsID0gZ2V0VXJsKGh0dHBDb25maWcpO1xyXG5cclxuICAgICAgICAgICAgLy8g6K6w5b2V5pel5b+X55qEL2RiL3N5c3RlbWxvZ+S5n+S4jeiiq+aLpuaIquWZqOWkhOeQhlxyXG4gICAgICAgICAgICB2YXIgaXNMb2dVcmwgPSAoJy9kYi9zeXN0ZW1sb2cnID09IF91cmwuc2xpY2UoMCwgMTMpKTtcclxuXHJcbiAgICAgICAgICAgIGlmIChpc0xvZ1VybCkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG5cclxuICAgICAgICBmdW5jdGlvbiBnZXRVcmwoaHR0cENvbmZpZzogYW55KSB7XHJcbiAgICAgICAgICAgIGlmICghaHR0cENvbmZpZykge1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS53YXJuKFwiaW50ZXJjZXB0b3IuZ2V0VXJsIGh0dHBDb25maWcgRXJyb3IsIGh0dHBDb25maWcgaXMgbnVsbCFcIik7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIGh0dHBDb25maWcudXJsO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLyoqXHJcbiAgICAgICAgICog5byA5ZCvL+WFs+mXreWFqOWxgOmBrue9qVxyXG4gICAgICAgICAqIEBwYXJhbSBpc0Nsb3NlIOaYr+WQpuaYr+WFs+mXreaTjeS9nFxyXG4gICAgICAgICAqL1xyXG4gICAgICAgIGZ1bmN0aW9uIHRvZ2dsZUxheWVyTG9hZCh1cmw/OiBzdHJpbmcsIGlzQ2xvc2U/OiBib29sZWFuKSB7XHJcbiAgICAgICAgICAgIGlmICghdXJsKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oXCJpbnRlcmNlcHRvci50b2dnbGVMb2FkaW5nIHVybCBFcnJvciwgdXJsIGlzIG51bGwhXCIpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmICh2bS5fTE9BRElOR19DQUNIRV9NQVBbdXJsXSAmJiBpc0Nsb3NlKSB7XHJcbiAgICAgICAgICAgICAgICAvLyDlhbPpl63pga7nvalcclxuICAgICAgICAgICAgICAgIGxheWVyLmNsb3NlKHZtLl9MT0FESU5HX0NBQ0hFX01BUFt1cmxdKTtcclxuICAgICAgICAgICAgICAgIGRlbGV0ZSB2bS5fTE9BRElOR19DQUNIRV9NQVBbdXJsXTtcclxuICAgICAgICAgICAgfSBlbHNlIGlmICghaXNDbG9zZSkge1xyXG4gICAgICAgICAgICAgICAgLy8g5LiN5piv5YWz6ZetLCDliJnmmK/lvIDlkK/pga7nvalcclxuICAgICAgICAgICAgICAgIHZtLl9MT0FESU5HX0NBQ0hFX01BUFt1cmxdID0gbGF5ZXIubG9hZCgzKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICB9XHJcbiAgICB9XHJcbn1cclxuXHJcbmFwcC5zZXJ2aWNlKCdodHRwSW50ZXJjZXB0b3InLCBIdHRwSW50ZXJjZXB0b3IpO1xyXG4iXX0=
