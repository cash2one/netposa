define(["require", "exports", "../../common/app/main.app", "../../common/directive/tree/tree-params", "../../../core/enum/TreeType", "../../../core/enum/ObjectType", "../../common/directive/tree/tree.directive.service", "../../common/services/connectTree.service", "../../common/factory/layerMsg.factory"], function (require, exports, main_app_1, tree_params_1, TreeType_1, ObjectType_1) {
    "use strict";
    Object.defineProperty(exports, "__esModule", { value: true });
    var DevicePopupWifiController = (function () {
        function DevicePopupWifiController($scope, $timeout, wifiService, treeService, connectTreeService, layerDec) {
            this.$scope = $scope;
            this.$timeout = $timeout;
            this.wifiService = wifiService;
            this.treeService = treeService;
            this.connectTreeService = connectTreeService;
            this.layerDec = layerDec;
            this.cacheChangeNodes = {};
            this.type = $scope.type;
            this.rightSelectTreeNodeId = null;
            this.initTreeParams();
            this.getLeftTreeData();
            this.getRightTreeData();
        }
        DevicePopupWifiController.prototype.initTreeParams = function () {
            var _this = this;
            this.leftTreeParams = new tree_params_1.TreeDataParams(true);
            this.leftTreeParams.treeId = "devicePopupLeftTree";
            this.leftTreeParams.isShowIcon = true;
            this.leftTreeParams.isShowLine = false;
            this.leftTreeParams.isSimpleData = true;
            this.leftTreeParams.checkEnable = false;
            this.leftTreeParams.isSingleSelect = false;
            this.leftTreeParams.editEnable = true;
            this.leftTreeParams.showRemoveBtn = false;
            this.leftTreeParams.showRenameBtn = false;
            this.leftTreeParams.beforeDrop = beforeDropRule;
            this.leftTreeParams.beforeDrag = beforeDragRule;
            if (this.type === TreeType_1.TreeType.lamp.value) {
                this.leftTreeParams.addDiyDom = function (treeId, treeNode) {
                    _this.treeService.addDiyDomIsConfiStatus(treeId, treeNode);
                };
            }
            this.rightTreeParams = new tree_params_1.TreeDataParams(true);
            this.rightTreeParams.treeId = "devicePopupRightTree";
            this.rightTreeParams.isShowIcon = true;
            this.rightTreeParams.isShowLine = false;
            this.rightTreeParams.isSimpleData = true;
            this.rightTreeParams.checkEnable = false;
            this.rightTreeParams.isSingleSelect = false;
            this.rightTreeParams.editEnable = true;
            this.rightTreeParams.showRemoveBtn = false;
            this.rightTreeParams.showRenameBtn = false;
            this.rightTreeParams.beforeDrop = beforeDropRule;
            this.rightTreeParams.beforeDrag = beforeDragRule;
            var _self = this;
            function beforeDropRule(treeId, treeNodes, targetNode) {
                if (treeId == _self.leftTreeParams.treeId) {
                    return false;
                }
                if (_self.type === TreeType_1.TreeType.lamp.value && targetNode.treeType !== TreeType_1.TreeType.lamp.value) {
                    return false;
                }
                if (_self.type === TreeType_1.TreeType.area.value && targetNode.treeType !== TreeType_1.TreeType.area.value) {
                    return false;
                }
                var newNodeList = [];
                var updateNodeList = [];
                treeNodes.forEach(function (item) {
                    item.ParentID = targetNode.ID;
                    item.isConfigLamp = true;
                    var node = _self.treeService.getNodeByParam(treeId, 'ID', item.ID);
                    if (node) {
                        updateNodeList.push(item);
                    }
                    else {
                        newNodeList.push(item);
                    }
                });
                if (updateNodeList.length > 0) {
                    _self.$timeout(function () {
                        _self.treeService.removeNodes(treeId, updateNodeList);
                        _self.treeService.addNodes(treeId, updateNodeList, targetNode);
                    });
                }
                if (newNodeList.length > 0) {
                    _self.treeService.addNodes(treeId, newNodeList, targetNode);
                }
                if (_self.type === TreeType_1.TreeType.lamp.value) {
                    _self.updateTreeDiyDom(treeId, treeNodes);
                }
                _self.changeNodesParentID(treeNodes, targetNode.ID);
                return false;
            }
            function beforeDragRule(treeId, treeNodes) {
                var flag = true;
                if (treeNodes && treeNodes.length > 0) {
                    var i = void 0, len = void 0, treeType = TreeType_1.TreeType.wifi.value;
                    for (i = 0, len = treeNodes.length; i < len; i++) {
                        if (treeNodes[i].treeType !== treeType) {
                            flag = false;
                            break;
                        }
                    }
                }
                else {
                    flag = false;
                }
                return flag;
            }
        };
        DevicePopupWifiController.prototype.updateTreeDiyDom = function (treeId, treeNodes) {
            var _this = this;
            this.$timeout(function () {
                treeNodes.forEach(function (item) {
                    _this.leftTreeParams.addDiyDom(treeId, item);
                });
            });
        };
        DevicePopupWifiController.prototype.changeNodesParentID = function (treeNodes, parentId) {
            if (!treeNodes || treeNodes.length <= 0)
                return;
            var i, len, temp, originParentId;
            for (i = 0, len = treeNodes.length; i < len; i++) {
                if (this.type === TreeType_1.TreeType.area.value) {
                    temp = treeNodes[i];
                    originParentId = temp.AreaID;
                    temp.ParentID = parentId;
                    temp.AreaID = parentId;
                }
                else if (this.type === TreeType_1.TreeType.lamp.value) {
                    temp = treeNodes[i];
                    if (!temp.JsonUserData.lampPost) {
                        var lampPost = {};
                        lampPost.ObjectId = parentId;
                        lampPost.ObjectType = ObjectType_1.ObjectType.LampPost.value;
                        lampPost.RelatedObjectId = temp.ID;
                        lampPost.RelatedObjectType = ObjectType_1.ObjectType.Wifi.value;
                        temp.JsonUserData.lampPost = lampPost;
                        originParentId = "";
                        temp.ParentID = parentId;
                    }
                    else {
                        originParentId = temp.JsonUserData.lampPost.ID;
                        temp.ParentID = parentId;
                        temp.JsonUserData.lampPost.ID = parentId;
                    }
                }
                this.addOrUpdateTreeChangeCache({ id: temp.ID, parentId: temp.ParentID, originParentId: originParentId, deviceReId: temp.JsonUserData.DeviceReId });
            }
        };
        DevicePopupWifiController.prototype.addOrUpdateTreeChangeCache = function (model) {
            if (this.cacheChangeNodes[model.id]) {
                this.cacheChangeNodes[model.id].parentId = model.parentId;
            }
            else {
                this.cacheChangeNodes[model.id] = model;
            }
        };
        DevicePopupWifiController.prototype.submit = function () {
            var _this = this;
            var key, temp, models = [], P;
            if (this.type === 'area') {
                for (key in this.cacheChangeNodes) {
                    temp = this.cacheChangeNodes[key];
                    models.push({ id: temp.id, areaId: temp.parentId });
                }
                if (models.length > 0) {
                    P = this.wifiService.updateWifiAreaID(models);
                }
                else {
                    this.layerDec.warnInfo("没有选择任何区域");
                    this.cancel(false);
                }
            }
            else {
                for (key in this.cacheChangeNodes) {
                    temp = this.cacheChangeNodes[key];
                    models.push({ id: temp.id, lampId: temp.parentId, deviceReId: temp.deviceReId });
                }
                if (models.length > 0) {
                    P = this.wifiService.updateWifiLampID(models);
                }
                else {
                    this.layerDec.warnInfo("没有选择任何立杆");
                    this.cancel(false);
                }
            }
            if (P) {
                P.then(function (res) {
                    if (res && res.code === 200) {
                        _this.cancel(true);
                    }
                    else {
                        console.error("wifiService.updateRmpGateAreaID error", res);
                    }
                });
            }
        };
        DevicePopupWifiController.prototype.cancel = function (flag) {
            this.$scope.$emit('device.closePopup', flag);
        };
        DevicePopupWifiController.prototype.getLeftTreeData = function () {
            var _this = this;
            this.wifiService.findAll().then(function (res) {
                _this.$timeout(function () {
                    _this.leftTreeParams.treeDatas = res;
                });
            });
        };
        DevicePopupWifiController.prototype.getRightTreeData = function () {
            var _this = this;
            var P;
            if (this.type === 'lamp') {
                P = this.connectTreeService.findLampTreeWithWifi();
            }
            else {
                P = this.connectTreeService.findAreaWithWifi();
            }
            P.then(function (datas) {
                _this.$timeout(function () {
                    _this.rightTreeParams.treeDatas = datas;
                });
            });
        };
        DevicePopupWifiController.$inject = ['$scope', '$timeout', 'wifiService', 'treeDirectiveService', 'connectTreeService', 'layerDec'];
        return DevicePopupWifiController;
    }());
    main_app_1.app.controller("baseConfigDevicePopupWifi", DevicePopupWifiController);
});

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNyYy9tb2R1bGUvYmFzZWNvbmZpZy93aWZpL3dpZmkucG9wdXBXaWZpLmNvbnRyb2xsZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0lBaUNBO1FBT0ksbUNBQ1ksTUFBVyxFQUNYLFFBQWEsRUFDYixXQUF5QixFQUN6QixXQUFrQyxFQUNsQyxrQkFBdUMsRUFDdkMsUUFBa0I7WUFMbEIsV0FBTSxHQUFOLE1BQU0sQ0FBSztZQUNYLGFBQVEsR0FBUixRQUFRLENBQUs7WUFDYixnQkFBVyxHQUFYLFdBQVcsQ0FBYztZQUN6QixnQkFBVyxHQUFYLFdBQVcsQ0FBdUI7WUFDbEMsdUJBQWtCLEdBQWxCLGtCQUFrQixDQUFxQjtZQUN2QyxhQUFRLEdBQVIsUUFBUSxDQUFVO1lBUDlCLHFCQUFnQixHQUFHLEVBQTJCLENBQUM7WUFTM0MsSUFBSSxDQUFDLElBQUksR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDO1lBQ3hCLElBQUksQ0FBQyxxQkFBcUIsR0FBRyxJQUFJLENBQUM7WUFDbEMsSUFBSSxDQUFDLGNBQWMsRUFBRSxDQUFDO1lBQ3RCLElBQUksQ0FBQyxlQUFlLEVBQUUsQ0FBQztZQUN2QixJQUFJLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztRQUM1QixDQUFDO1FBQ08sa0RBQWMsR0FBdEI7WUFBQSxpQkFxRkM7WUFwRkcsSUFBSSxDQUFDLGNBQWMsR0FBRyxJQUFJLDRCQUFjLENBQVMsSUFBSSxDQUFDLENBQUM7WUFDdkQsSUFBSSxDQUFDLGNBQWMsQ0FBQyxNQUFNLEdBQUcscUJBQXFCLENBQUM7WUFDbkQsSUFBSSxDQUFDLGNBQWMsQ0FBQyxVQUFVLEdBQUcsSUFBSSxDQUFDO1lBQ3RDLElBQUksQ0FBQyxjQUFjLENBQUMsVUFBVSxHQUFHLEtBQUssQ0FBQztZQUN2QyxJQUFJLENBQUMsY0FBYyxDQUFDLFlBQVksR0FBRyxJQUFJLENBQUM7WUFDeEMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxXQUFXLEdBQUcsS0FBSyxDQUFDO1lBQ3hDLElBQUks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O1lBQ1gsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksS0FBSyxNQUFNLENBQUMsQ0FBQyxDQUFDO2dCQUN2QixDQUFDLEdBQUcsSUFBSSxDQUFDLGtCQUFrQixDQUFDLG9CQUFvQixFQUFFLENBQUE7WUFDdEQsQ0FBQztZQUFDLElBQUksQ0FBQyxDQUFDO2dCQUNKLENBQUMsR0FBRyxJQUFJLENBQUMsa0JBQWtCLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQTtZQUNsRCxDQUFDO1lBRUQsQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFDLEtBQWlCO2dCQUNyQixLQUFJLENBQUMsUUFBUSxDQUFDO29CQUNWLEtBQUksQ0FBQyxlQUFlLENBQUMsU0FBUyxHQUFHLEtBQUssQ0FBQztnQkFDM0MsQ0FBQyxDQUFDLENBQUM7WUFDUCxDQUFDLENBQUMsQ0FBQTtRQUNOLENBQUM7UUF4Tk0saUNBQU8sR0FBRyxDQUFDLFFBQVEsRUFBRSxVQUFVLEVBQUUsYUFBYSxFQUFFLHNCQUFzQixFQUFFLG9CQUFvQixFQUFDLFVBQVUsQ0FBQyxDQUFDO1FBeU5wSCxnQ0FBQztLQTFORCxBQTBOQyxJQUFBO0lBRUQsY0FBRyxDQUFDLFVBQVUsQ0FBQywyQkFBMkIsRUFBRSx5QkFBeUIsQ0FBQyxDQUFDIiwiZmlsZSI6Im1vZHVsZS9iYXNlY29uZmlnL3dpZmkvd2lmaS5wb3B1cFdpZmkuY29udHJvbGxlci5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGFwcCB9IGZyb20gXCIuLi8uLi9jb21tb24vYXBwL21haW4uYXBwXCI7XHJcbmltcG9ydCB7IFRyZWVEYXRhUGFyYW1zIH0gZnJvbSBcIi4uLy4uL2NvbW1vbi9kaXJlY3RpdmUvdHJlZS90cmVlLXBhcmFtc1wiO1xyXG5pbXBvcnQge1dpZml9IGZyb20gXCIuLi8uLi8uLi9jb3JlL2VudGl0eS9XaWZpXCI7XHJcbmltcG9ydCB7V2lmaUV4fSBmcm9tIFwiLi4vLi4vLi4vY29yZS9lbnRpdHkvZXgvV2lmaUV4XCI7XHJcbmltcG9ydCB7IEFyZWFFeCB9IGZyb20gXCIuLi8uLi8uLi9jb3JlL2VudGl0eS9leC9BcmVhRXhcIjtcclxuaW1wb3J0IHsgTGFtcEV4IH0gZnJvbSBcIi4uLy4uLy4uL2NvcmUvZW50aXR5L2V4L0xhbXBFeFwiO1xyXG5pbXBvcnQge0lXaWZpU2VydmljZX0gZnJvbSBcIi4uLy4uL2NvbW1vbi9zZXJ2aWNlcy93aWZpLnNlcnZpY2VcIjtcclxuaW1wb3J0IFwiLi4vLi4vY29tbW9uL2RpcmVjdGl2ZS90cmVlL3RyZWUuZGlyZWN0aXZlLnNlcnZpY2VcIjtcclxuaW1wb3J0IHsgSVRyZWVEaXJlY3RpdmVTZXJ2aWNlIH0gZnJvbSBcIi4uLy4uL2NvbW1vbi9kaXJlY3RpdmUvdHJlZS90cmVlLmRpcmVjdGl2ZS5zZXJ2aWNlXCI7XHJcbmltcG9ydCB7V2lmaUNoYW5nZUFyZWFJRE1vZGVsfSBmcm9tIFwiLi4vLi4vLi4vY29yZS9wYXJhbXMvV2lmaVBhcmFtc1wiO1xyXG5pbXBvcnQgeyBSZXNwb25zZVJlc3VsdCB9IGZyb20gXCIuLi8uLi8uLi9jb3JlL3BhcmFtcy9yZXN1bHQvUmVzcG9uc2VSZXN1bHRcIjtcclxuaW1wb3J0IHsgVHJlZVR5cGUgfSBmcm9tIFwiLi4vLi4vLi4vY29yZS9lbnVtL1RyZWVUeXBlXCI7XHJcbmltcG9ydCB7IElDb25uZWN0VHJlZVNlcnZpY2UgfSBmcm9tIFwiLi4vLi4vY29tbW9uL3NlcnZpY2VzL2Nvbm5lY3RUcmVlLnNlcnZpY2VcIjtcclxuaW1wb3J0IFwiLi4vLi4vY29tbW9uL3NlcnZpY2VzL2Nvbm5lY3RUcmVlLnNlcnZpY2VcIjtcclxuaW1wb3J0IHsgUmVsYXRpb24gfSBmcm9tICcuLi8uLi8uLi9jb3JlL2VudGl0eS9EZXZpY2VSZWxhdGlvbic7XHJcbmltcG9ydCB7T2JqZWN0VHlwZX0gZnJvbSBcIi4uLy4uLy4uL2NvcmUvZW51bS9PYmplY3RUeXBlXCI7XHJcbmltcG9ydCB7SUxheWVyRGVjfSBmcm9tIFwiLi4vLi4vY29tbW9uL2ZhY3RvcnkvbGF5ZXJNc2cuZmFjdG9yeVwiO1xyXG5pbXBvcnQgIFwiLi4vLi4vY29tbW9uL2ZhY3RvcnkvbGF5ZXJNc2cuZmFjdG9yeVwiO1xyXG5cclxudHlwZSBBcmVhV2lmaUV4ID0gQXJlYUV4ICYgV2lmaUV4O1xyXG5cclxuaW50ZXJmYWNlIEFyZWFJRENhY2hlTW9kZWwge1xyXG4gICAgaWQ6IHN0cmluZztcclxuICAgIHBhcmVudElkOiBzdHJpbmc7XHJcbiAgICBvcmlnaW5QYXJlbnRJZDogc3RyaW5nO1xyXG4gICAgZGV2aWNlUmVJZD86IHN0cmluZztcclxufVxyXG5cclxuaW50ZXJmYWNlIEFyZWFJRENhY2hlQ29sbGVjdGlvbiB7XHJcbiAgICBba2V5OiBzdHJpbmddOiBBcmVhSURDYWNoZU1vZGVsO1xyXG59XHJcblxyXG5cclxuY2xhc3MgRGV2aWNlUG9wdXBXaWZpQ29udHJvbGxlciB7XHJcbiAgICBzdGF0aWMgJGluamVjdCA9IFsnJHNjb3BlJywgJyR0aW1lb3V0JywgJ3dpZmlTZXJ2aWNlJywgJ3RyZWVEaXJlY3RpdmVTZXJ2aWNlJywgJ2Nvbm5lY3RUcmVlU2VydmljZScsJ2xheWVyRGVjJ107XHJcbiAgICByaWdodFNlbGVjdFRyZWVOb2RlSWQ6IHN0cmluZztcclxuICAgIGxlZnRUcmVlUGFyYW1zOiBUcmVlRGF0YVBhcmFtczxXaWZpPjtcclxuICAgIHJpZ2h0VHJlZVBhcmFtczogVHJlZURhdGFQYXJhbXM8YW55PjtcclxuICAgIHR5cGU6IHN0cmluZztcclxuICAgIGNhY2hlQ2hhbmdlTm9kZXMgPSB7fSBhcyBBcmVhSURDYWNoZUNvbGxlY3Rpb247XHJcbiAgICBjb25zdHJ1Y3RvcihcclxuICAgICAgICBwcml2YXRlICRzY29wZTogYW55LFxyXG4gICAgICAgIHByaXZhdGUgJHRpbWVvdXQ6IGFueSxcclxuICAgICAgICBwcml2YXRlIHdpZmlTZXJ2aWNlOiBJV2lmaVNlcnZpY2UsXHJcbiAgICAgICAgcHJpdmF0ZSB0cmVlU2VydmljZTogSVRyZWVEaXJlY3RpdmVTZXJ2aWNlLFxyXG4gICAgICAgIHByaXZhdGUgY29ubmVjdFRyZWVTZXJ2aWNlOiBJQ29ubmVjdFRyZWVTZXJ2aWNlLFxyXG4gICAgICAgIHByaXZhdGUgbGF5ZXJEZWM6SUxheWVyRGVjXHJcbiAgICApIHtcclxuICAgICAgICB0aGlzLnR5cGUgPSAkc2NvcGUudHlwZTtcclxuICAgICAgICB0aGlzLnJpZ2h0U2VsZWN0VHJlZU5vZGVJZCA9IG51bGw7XHJcbiAgICAgICAgdGhpcy5pbml0VHJlZVBhcmFtcygpO1xyXG4gICAgICAgIHRoaXMuZ2V0TGVmdFRyZWVEYXRhKCk7XHJcbiAgICAgICAgdGhpcy5nZXRSaWdodFRyZWVEYXRhKCk7XHJcbiAgICB9XHJcbiAgICBwcml2YXRlIGluaXRUcmVlUGFyYW1zKCkge1xyXG4gICAgICAgIHRoaXMubGVmdFRyZWVQYXJhbXMgPSBuZXcgVHJlZURhdGFQYXJhbXM8V2lmaUV4Pih0cnVlKTtcclxuICAgICAgICB0aGlzLmxlZnRUcmVlUGFyYW1zLnRyZWVJZCA9IFwiZGV2aWNlUG9wdXBMZWZ0VHJlZVwiO1xyXG4gICAgICAgIHRoaXMubGVmdFRyZWVQYXJhbXMuaXNTaG93SWNvbiA9IHRydWU7XHJcbiAgICAgICAgdGhpcy5sZWZ0VHJlZVBhcmFtcy5pc1Nob3dMaW5lID0gZmFsc2U7XHJcbiAgICAgICAgdGhpcy5sZWZ0VHJlZVBhcmFtcy5pc1NpbXBsZURhdGEgPSB0cnVlO1xyXG4gICAgICAgIHRoaXMubGVmdFRyZWVQYXJhbXMuY2hlY2tFbmFibGUgPSBmYWxzZTtcclxuICAgICAgICB0aGlzLmxlZnRUcmVlUGFyYW1zLmlzU2luZ2xlU2VsZWN0ID0gZmFsc2U7XHJcbiAgICAgICAgdGhpcy5sZWZ0VHJlZVBhcmFtcy5lZGl0RW5hYmxlID0gdHJ1ZTtcclxuICAgICAgICB0aGlzLmxlZnRUcmVlUGFyYW1zLnNob3dSZW1vdmVCdG4gPSBmYWxzZTtcclxuICAgICAgICB0aGlzLmxlZnRUcmVlUGFyYW1zLnNob3dSZW5hbWVCdG4gPSBmYWxzZTtcclxuICAgICAgICB0aGlzLmxlZnRUcmVlUGFyYW1zLmJlZm9yZURyb3AgPSBiZWZvcmVEcm9wUnVsZTtcclxuICAgICAgICB0aGlzLmxlZnRUcmVlUGFyYW1zLmJlZm9yZURyYWcgPSBiZWZvcmVEcmFnUnVsZTtcclxuICAgICAgICBpZih0aGlzLnR5cGUgPT09IFRyZWVUeXBlLmxhbXAudmFsdWUpe1xyXG4gICAgICAgICAgICB0aGlzLmxlZnRUcmVlUGFyYW1zLmFkZERpeURvbSA9ICh0cmVlSWQ6IHN0cmluZywgdHJlZU5vZGU6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgdGhpcy50cmVlU2VydmljZS5hZGREaXlEb21Jc0NvbmZpU3RhdHVzKHRyZWVJZCwgdHJlZU5vZGUpO1xyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdGhpcy5yaWdodFRyZWVQYXJhbXMgPSBuZXcgVHJlZURhdGFQYXJhbXM8QXJlYVdpZmlFeD4odHJ1ZSk7XHJcbiAgICAgICAgdGhpcy5yaWdodFRyZWVQYXJhbXMudHJlZUlkID0gXCJkZXZpY2VQb3B1cFJpZ2h0VHJlZVwiO1xyXG4gICAgICAgIHRoaXMucmlnaHRUcmVlUGFyYW1zLmlzU2hvd0ljb24gPSB0cnVlO1xyXG4gICAgICAgIHRoaXMucmlnaHRUcmVlUGFyYW1zLmlzU2hvd0xpbmUgPSBmYWxzZTtcclxuICAgICAgICB0aGlzLnJpZ2h0VHJlZVBhcmFtcy5pc1NpbXBsZURhdGEgPSB0cnVlO1xyXG4gICAgICAgIHRoaXMucmlnaHRUcmVlUGFyYW1zLmNoZWNrRW5hYmxlID0gZmFsc2U7XHJcbiAgICAgICAgdGhpcy5yaWdodFRyZWVQYXJhbXMuaXNTaW5nbGVTZWxlY3QgPSBmYWxzZTtcclxuICAgICAgICB0aGlzLnJpZ2h0VHJlZVBhcmFtcy5lZGl0RW5hYmxlID0gdHJ1ZTtcclxuICAgICAgICB0aGlzLnJpZ2h0VHJlZVBhcmFtcy5zaG93UmVtb3ZlQnRuID0gZmFsc2U7XHJcbiAgICAgICAgdGhpcy5yaWdodFRyZWVQYXJhbXMuc2hvd1JlbmFtZUJ0biA9IGZhbHNlO1xyXG4gICAgICAgIHRoaXMucmlnaHRUcmVlUGFyYW1zLmJlZm9yZURyb3AgPSBiZWZvcmVEcm9wUnVsZTtcclxuICAgICAgICB0aGlzLnJpZ2h0VHJlZVBhcmFtcy5iZWZvcmVEcmFnID0gYmVmb3JlRHJhZ1J1bGU7XHJcbiAgICAgICAgbGV0IF9zZWxmID0gdGhpcyBhcyBEZXZpY2VQb3B1cFdpZmlDb250cm9sbGVyO1xyXG4gICAgICAgIGZ1bmN0aW9uIGJlZm9yZURyb3BSdWxlKHRyZWVJZDogc3RyaW5nLCB0cmVlTm9kZXM6IEFycmF5PFdpZmlFeD4sIHRhcmdldE5vZGU6IExhbXBFeCAmIEFyZWFFeCAmIFdpZmlFeCkge1xyXG4gICAgICAgICAgICBpZiAodHJlZUlkID09IF9zZWxmLmxlZnRUcmVlUGFyYW1zLnRyZWVJZCkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmIChfc2VsZi50eXBlID09PSBUcmVlVHlwZS5sYW1wLnZhbHVlICYmIHRhcmdldE5vZGUudHJlZVR5cGUgIT09IFRyZWVUeXBlLmxhbXAudmFsdWUpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAoX3NlbGYudHlwZSA9PT0gVHJlZVR5cGUuYXJlYS52YWx1ZSAmJiB0YXJnZXROb2RlLnRyZWVUeXBlICE9PSBUcmVlVHlwZS5hcmVhLnZhbHVlKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgbGV0IG5ld05vZGVMaXN0ID0gW10gYXMgQXJyYXk8V2lmaUV4PjtcclxuICAgICAgICAgICAgbGV0IHVwZGF0ZU5vZGVMaXN0ID0gW10gYXMgQXJyYXk8V2lmaUV4PjtcclxuICAgICAgICAgICAgdHJlZU5vZGVzLmZvckVhY2goKGl0ZW06IFdpZmlFeCB8IGFueSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgaXRlbS5QYXJlbnRJRCA9IHRhcmdldE5vZGUuSUQ7XHJcbiAgICAgICAgICAgICAgICBpdGVtLmlzQ29uZmlnTGFtcCA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICBsZXQgbm9kZSA9IF9zZWxmLnRyZWVTZXJ2aWNlLmdldE5vZGVCeVBhcmFtKHRyZWVJZCwgJ0lEJywgaXRlbS5JRCkgYXMgV2lmaUV4O1xyXG4gICAgICAgICAgICAgICAgaWYgKG5vZGUpIHtcclxuICAgICAgICAgICAgICAgICAgICB1cGRhdGVOb2RlTGlzdC5wdXNoKGl0ZW0pXHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIG5ld05vZGVMaXN0LnB1c2goaXRlbSlcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIGlmICh1cGRhdGVOb2RlTGlzdC5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgICAgICBfc2VsZi4kdGltZW91dCgoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgX3NlbGYudHJlZVNlcnZpY2UucmVtb3ZlTm9kZXModHJlZUlkLCB1cGRhdGVOb2RlTGlzdCk7XHJcbiAgICAgICAgICAgICAgICAgICAgX3NlbGYudHJlZVNlcnZpY2UuYWRkTm9kZXModHJlZUlkLCB1cGRhdGVOb2RlTGlzdCwgdGFyZ2V0Tm9kZSk7XHJcbiAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmIChuZXdOb2RlTGlzdC5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgICAgICBfc2VsZi50cmVlU2VydmljZS5hZGROb2Rlcyh0cmVlSWQsIG5ld05vZGVMaXN0LCB0YXJnZXROb2RlKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZihfc2VsZi50eXBlID09PSBUcmVlVHlwZS5sYW1wLnZhbHVlKXtcclxuICAgICAgICAgICAgICAgIF9zZWxmLnVwZGF0ZVRyZWVEaXlEb20odHJlZUlkLCB0cmVlTm9kZXMpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIF9zZWxmLmNoYW5nZU5vZGVzUGFyZW50SUQodHJlZU5vZGVzLCB0YXJnZXROb2RlLklEKTtcclxuICAgICAgICAgICAgcmV0dXJuIGZhbHNlXHJcblxyXG4gICAgICAgIH1cclxuICAgICAgICBmdW5jdGlvbiBiZWZvcmVEcmFnUnVsZSh0cmVlSWQ6IHN0cmluZywgdHJlZU5vZGVzOiBBcnJheTxXaWZpRXg+KSB7XHJcbiAgICAgICAgICAgIGxldCBmbGFnID0gdHJ1ZTtcclxuICAgICAgICAgICAgaWYgKHRyZWVOb2RlcyAmJiB0cmVlTm9kZXMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICAgICAgbGV0IGksIGxlbiwgdHJlZVR5cGUgPSBUcmVlVHlwZS53aWZpLnZhbHVlO1xyXG4gICAgICAgICAgICAgICAgZm9yIChpID0gMCwgbGVuID0gdHJlZU5vZGVzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRyZWVOb2Rlc1tpXS50cmVlVHlwZSAhPT0gdHJlZVR5cGUpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZmxhZyA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBmbGFnID0gZmFsc2U7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIGZsYWc7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgLyoqXHJcbiAgICAgKiBAZGVzYyDmibnph4/ljrvmm7TmlrBkaXlEb23nirbmgIFcclxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSB0cmVlSWRcclxuICAgICAqIEBwYXJhbSB7QXJyYXk8YW55Pn0gdHJlZU5vZGVzXHJcbiAgICAgKi9cclxuICAgIHVwZGF0ZVRyZWVEaXlEb20odHJlZUlkOiBzdHJpbmcsIHRyZWVOb2RlczogQXJyYXk8YW55Pikge1xyXG4gICAgICAgIHRoaXMuJHRpbWVvdXQoKCkgPT4ge1xyXG4gICAgICAgICAgICB0cmVlTm9kZXMuZm9yRWFjaCgoaXRlbTogYW55KSA9PiB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmxlZnRUcmVlUGFyYW1zLmFkZERpeURvbSh0cmVlSWQsIGl0ZW0pO1xyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgIH0pXHJcbiAgICB9XHJcbiAgICBwcml2YXRlIGNoYW5nZU5vZGVzUGFyZW50SUQodHJlZU5vZGVzOiBhbnksIHBhcmVudElkOiBzdHJpbmcpIHtcclxuICAgICAgICBpZiAoIXRyZWVOb2RlcyB8fCB0cmVlTm9kZXMubGVuZ3RoIDw9IDApIHJldHVybjtcclxuICAgICAgICBsZXQgaSwgbGVuLCB0ZW1wLCBvcmlnaW5QYXJlbnRJZDtcclxuICAgICAgICBmb3IgKGkgPSAwLCBsZW4gPSB0cmVlTm9kZXMubGVuZ3RoOyBpIDwgbGVuOyBpKyspIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMudHlwZSA9PT0gVHJlZVR5cGUuYXJlYS52YWx1ZSkge1xyXG4gICAgICAgICAgICAgICAgdGVtcCA9IHRyZWVOb2Rlc1tpXTtcclxuICAgICAgICAgICAgICAgIG9yaWdpblBhcmVudElkID0gdGVtcC5BcmVhSUQ7XHJcbiAgICAgICAgICAgICAgICB0ZW1wLlBhcmVudElEID0gcGFyZW50SWQ7XHJcbiAgICAgICAgICAgICAgICB0ZW1wLkFyZWFJRCA9IHBhcmVudElkO1xyXG4gICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMudHlwZSA9PT0gVHJlZVR5cGUubGFtcC52YWx1ZSkge1xyXG4gICAgICAgICAgICAgICAgdGVtcCA9IHRyZWVOb2Rlc1tpXTtcclxuICAgICAgICAgICAgICAgIGlmICghdGVtcC5Kc29uVXNlckRhdGEubGFtcFBvc3QpIHtcclxuICAgICAgICAgICAgICAgICAgICBsZXQgbGFtcFBvc3QgPSB7fSBhcyBSZWxhdGlvbjtcclxuICAgICAgICAgICAgICAgICAgICBsYW1wUG9zdC5PYmplY3RJZCA9IHBhcmVudElkO1xyXG4gICAgICAgICAgICAgICAgICAgIGxhbXBQb3N0Lk9iamVjdFR5cGUgPSBPYmplY3RUeXBlLkxhbXBQb3N0LnZhbHVlO1xyXG4gICAgICAgICAgICAgICAgICAgIGxhbXBQb3N0LlJlbGF0ZWRPYmplY3RJZCA9IHRlbXAuSUQ7XHJcbiAgICAgICAgICAgICAgICAgICAgbGFtcFBvc3QuUmVsYXRlZE9iamVjdFR5cGUgPSBPYmplY3RUeXBlLldpZmkudmFsdWU7XHJcbiAgICAgICAgICAgICAgICAgICAgdGVtcC5Kc29uVXNlckRhdGEubGFtcFBvc3QgPSBsYW1wUG9zdDtcclxuICAgICAgICAgICAgICAgICAgICBvcmlnaW5QYXJlbnRJZCA9IFwiXCI7XHJcbiAgICAgICAgICAgICAgICAgICAgdGVtcC5QYXJlbnRJRCA9IHBhcmVudElkO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICBvcmlnaW5QYXJlbnRJZCA9IHRlbXAuSnNvblVzZXJEYXRhLmxhbXBQb3N0LklEO1xyXG4gICAgICAgICAgICAgICAgICAgIHRlbXAuUGFyZW50SUQgPSBwYXJlbnRJZDtcclxuICAgICAgICAgICAgICAgICAgICB0ZW1wLkpzb25Vc2VyRGF0YS5sYW1wUG9zdC5JRCA9IHBhcmVudElkO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgdGhpcy5hZGRPclVwZGF0ZVRyZWVDaGFuZ2VDYWNoZSh7IGlkOiB0ZW1wLklELCBwYXJlbnRJZDogdGVtcC5QYXJlbnRJRCwgb3JpZ2luUGFyZW50SWQ6IG9yaWdpblBhcmVudElkLCBkZXZpY2VSZUlkOiB0ZW1wLkpzb25Vc2VyRGF0YS5EZXZpY2VSZUlkIH0pO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIHByaXZhdGUgYWRkT3JVcGRhdGVUcmVlQ2hhbmdlQ2FjaGUobW9kZWw6IEFyZWFJRENhY2hlTW9kZWwpIHtcclxuICAgICAgICBpZiAodGhpcy5jYWNoZUNoYW5nZU5vZGVzW21vZGVsLmlkXSkge1xyXG4gICAgICAgICAgICB0aGlzLmNhY2hlQ2hhbmdlTm9kZXNbbW9kZWwuaWRdLnBhcmVudElkID0gbW9kZWwucGFyZW50SWQ7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdGhpcy5jYWNoZUNoYW5nZU5vZGVzW21vZGVsLmlkXSA9IG1vZGVsO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBzdWJtaXQoKSB7XHJcbiAgICAgICAgbGV0IGtleSwgdGVtcCwgbW9kZWxzID0gW10gYXMgQXJyYXk8V2lmaUNoYW5nZUFyZWFJRE1vZGVsPiwgUDogYW55O1xyXG4gICAgICAgIGlmICh0aGlzLnR5cGUgPT09ICdhcmVhJykge1xyXG4gICAgICAgICAgICBmb3IgKGtleSBpbiB0aGlzLmNhY2hlQ2hhbmdlTm9kZXMpIHtcclxuICAgICAgICAgICAgICAgIHRlbXAgPSB0aGlzLmNhY2hlQ2hhbmdlTm9kZXNba2V5XTtcclxuICAgICAgICAgICAgICAgIG1vZGVscy5wdXNoKHsgaWQ6IHRlbXAuaWQsIGFyZWFJZDogdGVtcC5wYXJlbnRJZCB9IGFzIFdpZmlDaGFuZ2VBcmVhSURNb2RlbCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKG1vZGVscy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgICAgICBQID0gdGhpcy53aWZpU2VydmljZS51cGRhdGVXaWZpQXJlYUlEKG1vZGVscyk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmxheWVyRGVjLndhcm5JbmZvKFwi5rKh5pyJ6YCJ5oup5Lu75L2V5Yy65Z+fXCIpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5jYW5jZWwoZmFsc2UpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgZm9yIChrZXkgaW4gdGhpcy5jYWNoZUNoYW5nZU5vZGVzKSB7XHJcbiAgICAgICAgICAgICAgICB0ZW1wID0gdGhpcy5jYWNoZUNoYW5nZU5vZGVzW2tleV07XHJcbiAgICAgICAgICAgICAgICBtb2RlbHMucHVzaCh7IGlkOiB0ZW1wLmlkLCBsYW1wSWQ6IHRlbXAucGFyZW50SWQsIGRldmljZVJlSWQ6IHRlbXAuZGV2aWNlUmVJZCB9IGFzIFdpZmlDaGFuZ2VBcmVhSURNb2RlbCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKG1vZGVscy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgICAgICBQID0gdGhpcy53aWZpU2VydmljZS51cGRhdGVXaWZpTGFtcElEKG1vZGVscyk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmxheWVyRGVjLndhcm5JbmZvKFwi5rKh5pyJ6YCJ5oup5Lu75L2V56uL5p2GXCIpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5jYW5jZWwoZmFsc2UpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChQKSB7XHJcbiAgICAgICAgICAgIFAudGhlbigocmVzOiBSZXNwb25zZVJlc3VsdDxib29sZWFuPikgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKHJlcyAmJiByZXMuY29kZSA9PT0gMjAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5jYW5jZWwodHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoXCJ3aWZpU2VydmljZS51cGRhdGVSbXBHYXRlQXJlYUlEIGVycm9yXCIsIHJlcyk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgfVxyXG5cclxuICAgIH1cclxuICAgIGNhbmNlbChmbGFnPzogYm9vbGVhbikge1xyXG4gICAgICAgIHRoaXMuJHNjb3BlLiRlbWl0KCdkZXZpY2UuY2xvc2VQb3B1cCcsIGZsYWcpO1xyXG4gICAgfVxyXG4gICAgcHJpdmF0ZSBnZXRMZWZ0VHJlZURhdGEoKSB7XHJcbiAgICAgICAgdGhpcy53aWZpU2VydmljZS5maW5kQWxsKCkudGhlbigocmVzOiBBcnJheTxXaWZpRXg+KSA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMuJHRpbWVvdXQoKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5sZWZ0VHJlZVBhcmFtcy50cmVlRGF0YXMgPSByZXM7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgcHJpdmF0ZSBnZXRSaWdodFRyZWVEYXRhKCkge1xyXG4gICAgICAgIGxldCBQOiBhbnk7XHJcbiAgICAgICAgaWYgKHRoaXMudHlwZSA9PT0gJ2xhbXAnKSB7XHJcbiAgICAgICAgICAgIFAgPSB0aGlzLmNvbm5lY3RUcmVlU2VydmljZS5maW5kTGFtcFRyZWVXaXRoV2lmaSgpXHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgUCA9IHRoaXMuY29ubmVjdFRyZWVTZXJ2aWNlLmZpbmRBcmVhV2l0aFdpZmkoKVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgUC50aGVuKChkYXRhczogQXJyYXk8YW55PikgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLiR0aW1lb3V0KCgpID0+IHtcclxuICAgICAgICAgICAgICAgIHRoaXMucmlnaHRUcmVlUGFyYW1zLnRyZWVEYXRhcyA9IGRhdGFzO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9KVxyXG4gICAgfVxyXG59XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICBcclxuYXBwLmNvbnRyb2xsZXIoXCJiYXNlQ29uZmlnRGV2aWNlUG9wdXBXaWZpXCIsIERldmljZVBvcHVwV2lmaUNvbnRyb2xsZXIpOyJdfQ==
