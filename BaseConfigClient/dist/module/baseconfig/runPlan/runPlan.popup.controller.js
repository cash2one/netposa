define(["require", "exports", "../../common/app/main.app", "../../common/portrait-tool", "../../../core/entity/ex/TimeTemplateEx", "./TimeDraw", "../../../core/server/enum/ThresholdType", "angular", "../../common/services/timeTemplate.service", "../../common/factory/layerMsg.factory"], function (require, exports, main_app_1, portrait_tool_1, TimeTemplateEx_1, TimeDraw_1, ThresholdType_1) {
    "use strict";
    Object.defineProperty(exports, "__esModule", { value: true });
    var RunPlanPopupController = (function () {
        function RunPlanPopupController($scope, $timeout, layerDec, timeTemplateService) {
            this.$scope = $scope;
            this.$timeout = $timeout;
            this.layerDec = layerDec;
            this.timeTemplateService = timeTemplateService;
            this.currentDate = portrait_tool_1.default.formatDate(new Date());
            this.timeDrawModel = new TimeDraw_1.TimeDraw();
            this.currentModelID = '';
            this.currentModel = new TimeTemplateEx_1.TimeTemplateEx();
            this.listTemplateModel = [];
            this.initTemplateList();
            this.isUpdate = this.$scope.isUpdate;
            this.initTimeTemplateLayer();
        }
        RunPlanPopupController.prototype.initTemplateList = function () {
            var _this = this;
            this.timeTemplateService.findAll().then(function (res) {
                if (res.code === 200) {
                    _this.listTemplateModel = res.data;
                }
            });
        };
        RunPlanPopupController.prototype.initTimeTemplateLayer = function () {
            var _this = this;
            this.$timeout(function () {
                _this.timeDrawModel.grid.init();
                _this.timeDrawModel.activeTimeType = ThresholdType_1.ThresholdType.Hight.value;
                if (_this.isUpdate) {
                    _this.currentModel = _this.$scope.timeTplModel;
                    _this.timeDrawModel.drawByWeekItems(angular.fromJson(_this.currentModel.WeekContent));
                    _this.timeDrawModel.drawByDateItems(angular.fromJson(_this.currentModel.DayContent));
                }
            });
        };
        RunPlanPopupController.prototype.changeTempaltelayer = function (ID) {
            this.timeDrawModel.clearShapeByType(ThresholdType_1.ThresholdType.Hight.value);
            for (var i = 0; i < this.listTemplateModel.length; i++) {
                if (this.listTemplateModel[i].ID === ID) {
                    try {
                        this.currentModel.WeekItems = JSON.parse(this.listTemplateModel[i].WeekContent);
                        this.currentModel.DateItems = JSON.parse(this.listTemplateModel[i].DayContent);
                        this.currentModel.WeekItems.forEach(function (item) {
                            item.TimeItems.forEach(function (item2) {
                                item2.ThresholdType = ThresholdType_1.ThresholdType.Hight.value;
                            });
                        });
                        this.currentModel.DateItems.forEach(function (item) {
                            item.TimeItems.forEach(function (item2) {
                                item2.ThresholdType = ThresholdType_1.ThresholdType.Hight.value;
                            });
                        });
                        this.timeDrawModel.activeTimeType = ThresholdType_1.ThresholdType.Hight.value;
                        this.timeDrawModel.drawByWeekItems(this.currentModel.WeekItems);
                        this.timeDrawModel.drawByDateItems(this.currentModel.DateItems);
                    }
                    catch (e) {
                        console.error('Date Params is Error');
                        this.timeDrawModel.shape.clearShape();
                        this.timeDrawModel.drawByWeekItems([]);
                        this.timeDrawModel.drawByDateItems([]);
                    }
                    break;
                }
            }
        };
        RunPlanPopupController.prototype.closeUpdateModel = function (isFresh, itemNode) {
            this.$scope.$emit('add.runplan.popup', isFresh, itemNode);
        };
        RunPlanPopupController.prototype.addCustomDayLine = function () {
            this.timeDrawModel.addGripLine(this.customStartDate, this.customEndDate, this.customInfo);
        };
        ;
        RunPlanPopupController.prototype.commitSaveOrUpdate = function () {
            var _this = this;
            var drawResult = this.timeDrawModel.getDrawArea();
            this.currentModel.DateItems = drawResult.DateItems;
            this.currentModel.WeekItems = drawResult.WeekItems;
            if (!this.validate()) {
                return;
            }
            var templateModel = angular.copy(this.currentModel);
            templateModel.CreateTime = Date.now().toString();
            templateModel.DayContent = angular.toJson(this.currentModel.DateItems);
            templateModel.WeekContent = angular.toJson(this.currentModel.WeekItems);
            templateModel.WeekItems = null;
            templateModel.DateItems = null;
            templateModel.IsTemplate = !this.$scope.isTask;
            if (this.isUpdate) {
                this.timeTemplateService.update(templateModel).then(function (resp) {
                    if (resp.code === 200) {
                        _this.closeUpdateModel(true, templateModel);
                    }
                });
            }
            else {
                this.timeTemplateService.save(templateModel).then(function (resp) {
                    if (resp.code === 200) {
                        templateModel.ID = resp.data;
                        _this.closeUpdateModel(true, templateModel);
                    }
                });
            }
        };
        ;
        RunPlanPopupController.prototype.validate = function () {
            if (!this.currentModel.Name) {
                this.layerDec.warnInfo("未填写时间模板名称！");
                return false;
            }
            var hasTimeItem = false;
            angular.forEach(this.currentModel.WeekItems, function (val) {
                if (val.TimeItems && val.TimeItems.length > 0) {
                    hasTimeItem = true;
                }
            });
            if (!hasTimeItem && this.currentModel.DateItems.length === 0) {
                this.layerDec.warnInfo("未做时间模板时间选择！");
                return false;
            }
            return true;
        };
        ;
        RunPlanPopupController.$inject = ['$scope', '$timeout', 'layerDec', 'timeTemplateService'];
        return RunPlanPopupController;
    }());
    main_app_1.app.controller('runPlanPopupController', RunPlanPopupController);
});

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNyYy9tb2R1bGUvYmFzZWNvbmZpZy9ydW5QbGFuL3J1blBsYW4ucG9wdXAuY29udHJvbGxlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7SUE0QkE7UUFZSSxnQ0FBb0IsTUFBVyxFQUNYLFFBQWEsRUFDYixRQUFtQixFQUNuQixtQkFBeUM7WUFIekMsV0FBTSxHQUFOLE1BQU0sQ0FBSztZQUNYLGFBQVEsR0FBUixRQUFRLENBQUs7WUFDYixhQUFRLEdBQVIsUUFBUSxDQUFXO1lBQ25CLHdCQUFtQixHQUFuQixtQkFBbUIsQ0FBc0I7WUFkN0QsZ0JBQVcsR0FBVyx1QkFBWSxDQUFDLFVBQVUsQ0FBQyxJQUFJLElBQUksRUFBRSxDQUFDLENBQUM7WUFLMUQsa0JBQWEsR0FBYyxJQUFJLG1CQUFRLEVBQUUsQ0FBQztZQUMxQyxtQkFBYyxHQUFXLEVBQUUsQ0FBQztZQUM1QixpQkFBWSxHQUFtQixJQUFJLCtCQUFjLEVBQUUsQ0FBQztZQUNwRCxzQkFBaUIsR0FBeUIsRUFBRSxDQUFDO1lBT3pDLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1lBQ3hCLElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUM7WUFDckMsSUFBSSxDQUFDLHFCQUFxQixFQUFFLENBQUM7UUFFakMsQ0FBQztRQUNELGlEQUFnQixHQUFoQjtZQUFBLGlCQU1DO1lBTEcsSUFBSSxDQUFDLG1CQUFtQixDQUFDLE9BQU8sRUFBRSxDQUFDLElBQUksQ0FBQyxVQUFDLEdBQXlDO2dCQUM5RSxFQUFFLENBQUEsQ0FBQyxHQUFHLENBQUMsSUFBSSxLQUFLLEdBQUcsQ0FBQyxDQUFBLENBQUM7b0JBQ2pCLEtBQUksQ0FBQyxpQkFBaUIsR0FBRyxHQUFHLENBQUMsSUFBSSxDQUFDO2dCQUN0QyxDQUFDO1lBQ0wsQ0FBQyxDQUFDLENBQUE7UUFDTixDQUFDO1FBQ0Qsc0RBQXFCLEdBQXJCO1lBQUEsaUJBV0M7WUFWRyxJQUFJLENBQUMsUUFBUSxDQUFDO2dCQUNWLEtBQUksQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO2dCQUMvQixLQUFJLENBQUMsYUFBYSxDQUFDLGNBQWMsR0FBRyw2QkFBYSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUM7Z0JBQzlELEVBQUUsQ0FBQyxDQUFDLEtBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO29CQUNoQixLQUFJLENBQUMsWUFBWSxHQUFHLEtBQUksQ0FBQyxNQUFNLENBQUMsWUFBWSxDQUFDO29CQUM3QyxLQUFJLENBQUMsYUFBYSxDQUFDLGVBQWUsQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLEtBQUksQ0FBQyxZQUFZLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQztvQkFDcEYsS0FBSSxDQUFDLGFBQWEsQ0FBQyxlQUFlLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxLQUFJLENBQUMsWUFBWSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUM7Z0JBQ3ZGLENBQUM7WUFFTCxDQUFDLENBQUMsQ0FBQztRQUNQLENBQUM7UUFDRCxvREFBbUIsR0FBbkIsVUFBb0IsRUFBUztZQUN6QixJQUFJLENBQUMsYUFBYSxDQUFDLGdCQUFnQixDQUFDLDZCQUFhLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQy9ELEdBQUcsQ0FBQSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBQyxDQUFDLEdBQUMsSUFBSSxDQUFDLGlCQUFpQixDQUFDLE1BQU0sRUFBQyxDQUFDLEVBQUUsRUFBQyxDQUFDO2dCQUMvQyxFQUFFLENBQUEsQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFBLENBQUM7b0JBQ3BDLElBQUksQ0FBQzt3QkFDRCxJQUFJLENBQUMsWUFBWSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDLENBQUMsQ0FBQyxXQUFXLENBQUMsQ0FBQzt3QkFDaEYsSUFBSSxDQUFDLFlBQVksQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsQ0FBQyxDQUFDLENBQUMsVUFBVSxDQUFDLENBQUM7d0JBQy9FLElBQUksQ0FBQyxZQUFZLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxVQUFDLElBQWE7NEJBQzlDLElBQUksQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLFVBQUMsS0FBYztnQ0FDbEMsS0FBSyxDQUFDLGFBQWEsR0FBRyw2QkFBYSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUM7NEJBQ3BELENBQUMsQ0FBQyxDQUFBO3dCQUNOLENBQUMsQ0FBQyxDQUFDO3dCQUNILElBQUksQ0FBQyxZQUFZLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxVQUFDLElBQWE7NEJBQzlDLElBQUksQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLFVBQUMsS0FBYztnQ0FDbEMsS0FBSyxDQUFDLGFBQWEsR0FBRyw2QkFBYSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUM7NEJBQ3BELENBQUMsQ0FBQyxDQUFBO3dCQUNOLENBQUMsQ0FBQyxDQUFDO3dCQUNILElBQUksQ0FBQyxhQUFhLENBQUMsY0FBYyxHQUFHLDZCQUFhLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQzt3QkFDOUQsSUFBSSxDQUFDLGFBQWEsQ0FBQyxlQUFlLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxTQUFTLENBQUMsQ0FBQzt3QkFDaEUsSUFBSSxDQUFDLGFBQWEsQ0FBQyxlQUFlLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxTQUFTLENBQUMsQ0FBQztvQkFFcEUsQ0FBQztvQkFBQSxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQSxDQUFDO3dCQUNQLE9BQU8sQ0FBQyxLQUFLLENBQUMsc0JBQXNCLENBQUMsQ0FBQzt3QkFDdEMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsVUFBVSxFQUFFLENBQUM7d0JBQ3RDLElBQUksQ0FBQyxhQUFhLENBQUMsZUFBZSxDQUFDLEVBQUUsQ0FBQyxDQUFDO3dCQUN2QyxJQUFJLENBQUMsYUFBYSxDQUFDLGVBQWUsQ0FBQyxFQUFFLENBQUMsQ0FBQztvQkFDM0MsQ0FBQztvQkFDRCxLQUFLLENBQUM7Z0JBQ1YsQ0FBQztZQUNMLENBQUM7UUFDTCxDQUFDO1FBR0QsaURBQWdCLEdBQWhCLFVBQWlCLE9BQWlCLEVBQUUsUUFBeUI7WUFDekQsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsbUJBQW1CLEVBQUUsT0FBTyxFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBQzlELENBQUM7UUFHRCxpREFBZ0IsR0FBaEI7WUFDSSxJQUFJLENBQUMsYUFBYSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsZUFBZSxFQUFFLElBQUksQ0FBQyxhQUFhLEVBQUUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBRTlGLENBQUM7UUFBQSxDQUFDO1FBRUYsbURBQWtCLEdBQWxCO1lBQUEsaUJBK0JDO1lBOUJHLElBQUksVUFBVSxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsV0FBVyxFQUFFLENBQUM7WUFDbEQsSUFBSSxDQUFDLFlBQVksQ0FBQyxTQUFTLEdBQUcsVUFBVSxDQUFDLFNBQVMsQ0FBQztZQUNuRCxJQUFJLENBQUMsWUFBWSxDQUFDLFNBQVMsR0FBRyxVQUFVLENBQUMsU0FBUyxDQUFDO1lBR25ELEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUMsQ0FBQztnQkFDbkIsTUFBTSxDQUFDO1lBQ1gsQ0FBQztZQUVELElBQUksYUFBYSxHQUFHLE9BQU8sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDO1lBQ3BELGFBQWEsQ0FBQyxVQUFVLEdBQUcsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDLFFBQVEsRUFBRSxDQUFDO1lBQ2pELGFBQWEsQ0FBQyxVQUFVLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1lBQ3ZFLGFBQWEsQ0FBQyxXQUFXLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1lBQ3hFLGFBQWEsQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDO1lBQy9CLGFBQWEsQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDO1lBQy9CLGFBQWEsQ0FBQyxVQUFVLEdBQUcsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQztZQUMvQyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQztnQkFDaEIsSUFBSSxDQUFDLG1CQUFtQixDQUFDLE1BQU0sQ0FBQyxhQUFhLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBQyxJQUE0QjtvQkFDN0UsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksS0FBSyxHQUFHLENBQUMsQ0FBQyxDQUFDO3dCQUNwQixLQUFJLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxFQUFFLGFBQWEsQ0FBQyxDQUFDO29CQUMvQyxDQUFDO2dCQUNMLENBQUMsQ0FBQyxDQUFDO1lBQ1AsQ0FBQztZQUFDLElBQUksQ0FBQyxDQUFDO2dCQUNKLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUMsSUFBSSxDQUFDLFVBQUMsSUFBNEI7b0JBQzNFLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLEtBQUssR0FBRyxDQUFDLENBQUMsQ0FBQzt3QkFDcEIsYUFBYSxDQUFDLEVBQUUsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDO3dCQUM3QixLQUFJLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxFQUFFLGFBQWEsQ0FBQyxDQUFDO29CQUMvQyxDQUFDO2dCQUNMLENBQUMsQ0FBQyxDQUFDO1lBQ1AsQ0FBQztRQUNMLENBQUM7UUFBQSxDQUFDO1FBR0YseUNBQVEsR0FBUjtZQUNJLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO2dCQUMxQixJQUFJLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxZQUFZLENBQUMsQ0FBQztnQkFDckMsTUFBTSxDQUFDLEtBQUssQ0FBQztZQUNqQixDQUFDO1lBQ0QsSUFBSSxXQUFXLEdBQUcsS0FBSyxDQUFDO1lBQ3hCLE9BQU8sQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxTQUFTLEVBQUUsVUFBQyxHQUFhO2dCQUN2RCxFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsU0FBUyxJQUFJLEdBQUcsQ0FBQyxTQUFTLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7b0JBQzVDLFdBQVcsR0FBRyxJQUFJLENBQUM7Z0JBQ3ZCLENBQUM7WUFDTCxDQUFDLENBQUMsQ0FBQztZQUVILEVBQUUsQ0FBQyxDQUFDLENBQUMsV0FBVyxJQUFJLElBQUksQ0FBQyxZQUFZLENBQUMsU0FBUyxDQUFDLE1BQU0sS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUMzRCxJQUFJLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxhQUFhLENBQUMsQ0FBQztnQkFDdEMsTUFBTSxDQUFDLEtBQUssQ0FBQztZQUNqQixDQUFDO1lBQ0QsTUFBTSxDQUFDLElBQUksQ0FBQztRQUNoQixDQUFDO1FBQUEsQ0FBQztRQTVISyw4QkFBTyxHQUFHLENBQUMsUUFBUSxFQUFFLFVBQVUsRUFBRSxVQUFVLEVBQUUscUJBQXFCLENBQUMsQ0FBQztRQThIL0UsNkJBQUM7S0F4SUQsQUF3SUMsSUFBQTtJQUVELGNBQUcsQ0FBQyxVQUFVLENBQUMsd0JBQXdCLEVBQUUsc0JBQXNCLENBQUMsQ0FBQyIsImZpbGUiOiJtb2R1bGUvYmFzZWNvbmZpZy9ydW5QbGFuL3J1blBsYW4ucG9wdXAuY29udHJvbGxlci5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7YXBwfSBmcm9tIFwiLi4vLi4vY29tbW9uL2FwcC9tYWluLmFwcFwiO1xyXG5pbXBvcnQgJ2FuZ3VsYXInO1xyXG5cclxuaW1wb3J0IFBvcnRyYWl0VG9vbCBmcm9tIFwiLi4vLi4vY29tbW9uL3BvcnRyYWl0LXRvb2xcIjtcclxuaW1wb3J0IHtFbnVtfSBmcm9tIFwiLi4vLi4vLi4vY29yZS9lbnVtL0VudW1cIjtcclxuXHJcbmltcG9ydCBcIi4uLy4uL2NvbW1vbi9zZXJ2aWNlcy90aW1lVGVtcGxhdGUuc2VydmljZVwiO1xyXG5pbXBvcnQge0lUaW1lVGVtcGxhdGVTZXJ2aWNlfSBmcm9tIFwiLi4vLi4vY29tbW9uL3NlcnZpY2VzL3RpbWVUZW1wbGF0ZS5zZXJ2aWNlXCI7XHJcblxyXG5pbXBvcnQge1RpbWVUZW1wbGF0ZX0gZnJvbSBcIi4uLy4uLy4uL2NvcmUvZW50aXR5L1RpbWVUZW1wbGF0ZVwiO1xyXG5pbXBvcnQge1xyXG4gICAgVGltZVRlbXBsYXRlRXgsXHJcbiAgICBUaW1lVGVtcGxhdGVUeXBlLFxyXG4gICAgV2Vla0l0ZW0sXHJcbiAgICBUaW1lSXRlbSxcclxuICAgIERhdGVJdGVtXHJcbn0gZnJvbSBcIi4uLy4uLy4uL2NvcmUvZW50aXR5L2V4L1RpbWVUZW1wbGF0ZUV4XCI7XHJcblxyXG5cclxuaW1wb3J0IHtUaW1lRHJhd30gZnJvbSBcIi4vVGltZURyYXdcIjtcclxuaW1wb3J0IHtSZXNwb25zZVJlc3VsdH0gZnJvbSBcIi4uLy4uLy4uL2NvcmUvcGFyYW1zL3Jlc3VsdC9SZXNwb25zZVJlc3VsdFwiO1xyXG5pbXBvcnQge1RocmVzaG9sZFR5cGV9IGZyb20gXCIuLi8uLi8uLi9jb3JlL3NlcnZlci9lbnVtL1RocmVzaG9sZFR5cGVcIjtcclxuaW1wb3J0IHtJTGF5ZXJEZWN9IGZyb20gXCIuLi8uLi9jb21tb24vZmFjdG9yeS9sYXllck1zZy5mYWN0b3J5XCI7XHJcbmltcG9ydCBcIi4uLy4uL2NvbW1vbi9mYWN0b3J5L2xheWVyTXNnLmZhY3RvcnlcIjtcclxuXHJcbmRlY2xhcmUgbGV0IGFuZ3VsYXI6IGFueTtcclxuZGVjbGFyZSBsZXQgJDogYW55O1xyXG5cclxuY2xhc3MgUnVuUGxhblBvcHVwQ29udHJvbGxlciB7XHJcbiAgICBjdXJyZW50RGF0ZTogc3RyaW5nID0gUG9ydHJhaXRUb29sLmZvcm1hdERhdGUobmV3IERhdGUoKSk7XHJcbiAgICBjdXN0b21TdGFydERhdGU6IHN0cmluZztcclxuICAgIGN1c3RvbUVuZERhdGU6IHN0cmluZztcclxuICAgIGN1c3RvbUluZm86IHN0cmluZztcclxuICAgIGlzVXBkYXRlOiBib29sZWFuO1xyXG4gICAgdGltZURyYXdNb2RlbDogVGltZURyYXcgPSAgbmV3IFRpbWVEcmF3KCk7XHJcbiAgICBjdXJyZW50TW9kZWxJRDogc3RyaW5nID0gJyc7XHJcbiAgICBjdXJyZW50TW9kZWw6IFRpbWVUZW1wbGF0ZUV4ID0gbmV3IFRpbWVUZW1wbGF0ZUV4KCk7XHJcbiAgICBsaXN0VGVtcGxhdGVNb2RlbDpBcnJheTxUaW1lVGVtcGxhdGVFeD4gPSBbXTtcclxuICAgIHN0YXRpYyAkaW5qZWN0ID0gWyckc2NvcGUnLCAnJHRpbWVvdXQnLCAnbGF5ZXJEZWMnLCAndGltZVRlbXBsYXRlU2VydmljZSddO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgJHNjb3BlOiBhbnksXHJcbiAgICAgICAgICAgICAgICBwcml2YXRlICR0aW1lb3V0OiBhbnksXHJcbiAgICAgICAgICAgICAgICBwcml2YXRlIGxheWVyRGVjOiBJTGF5ZXJEZWMsXHJcbiAgICAgICAgICAgICAgICBwcml2YXRlIHRpbWVUZW1wbGF0ZVNlcnZpY2U6IElUaW1lVGVtcGxhdGVTZXJ2aWNlLCkge1xyXG4gICAgICAgIHRoaXMuaW5pdFRlbXBsYXRlTGlzdCgpO1xyXG4gICAgICAgIHRoaXMuaXNVcGRhdGUgPSB0aGlzLiRzY29wZS5pc1VwZGF0ZTtcclxuICAgICAgICB0aGlzLmluaXRUaW1lVGVtcGxhdGVMYXllcigpO1xyXG5cclxuICAgIH1cclxuICAgIGluaXRUZW1wbGF0ZUxpc3QoKXtcclxuICAgICAgICB0aGlzLnRpbWVUZW1wbGF0ZVNlcnZpY2UuZmluZEFsbCgpLnRoZW4oKHJlczpSZXNwb25zZVJlc3VsdDxBcnJheTxUaW1lVGVtcGxhdGVFeD4+KT0+e1xyXG4gICAgICAgICAgICBpZihyZXMuY29kZSA9PT0gMjAwKXtcclxuICAgICAgICAgICAgICAgIHRoaXMubGlzdFRlbXBsYXRlTW9kZWwgPSByZXMuZGF0YTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pXHJcbiAgICB9XHJcbiAgICBpbml0VGltZVRlbXBsYXRlTGF5ZXIoKSB7XHJcbiAgICAgICAgdGhpcy4kdGltZW91dCgoKSA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMudGltZURyYXdNb2RlbC5ncmlkLmluaXQoKTtcclxuICAgICAgICAgICAgdGhpcy50aW1lRHJhd01vZGVsLmFjdGl2ZVRpbWVUeXBlID0gVGhyZXNob2xkVHlwZS5IaWdodC52YWx1ZTtcclxuICAgICAgICAgICAgaWYgKHRoaXMuaXNVcGRhdGUpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudE1vZGVsID0gdGhpcy4kc2NvcGUudGltZVRwbE1vZGVsO1xyXG4gICAgICAgICAgICAgICAgdGhpcy50aW1lRHJhd01vZGVsLmRyYXdCeVdlZWtJdGVtcyhhbmd1bGFyLmZyb21Kc29uKHRoaXMuY3VycmVudE1vZGVsLldlZWtDb250ZW50KSk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnRpbWVEcmF3TW9kZWwuZHJhd0J5RGF0ZUl0ZW1zKGFuZ3VsYXIuZnJvbUpzb24odGhpcy5jdXJyZW50TW9kZWwuRGF5Q29udGVudCkpO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgY2hhbmdlVGVtcGFsdGVsYXllcihJRDpzdHJpbmcpe1xyXG4gICAgICAgIHRoaXMudGltZURyYXdNb2RlbC5jbGVhclNoYXBlQnlUeXBlKFRocmVzaG9sZFR5cGUuSGlnaHQudmFsdWUpO1xyXG4gICAgICAgIGZvcihsZXQgaSA9IDA7aTx0aGlzLmxpc3RUZW1wbGF0ZU1vZGVsLmxlbmd0aDtpKyspe1xyXG4gICAgICAgICAgICBpZih0aGlzLmxpc3RUZW1wbGF0ZU1vZGVsW2ldLklEID09PSBJRCl7XHJcbiAgICAgICAgICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudE1vZGVsLldlZWtJdGVtcyA9IEpTT04ucGFyc2UodGhpcy5saXN0VGVtcGxhdGVNb2RlbFtpXS5XZWVrQ29udGVudCk7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50TW9kZWwuRGF0ZUl0ZW1zID0gSlNPTi5wYXJzZSh0aGlzLmxpc3RUZW1wbGF0ZU1vZGVsW2ldLkRheUNvbnRlbnQpO1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudE1vZGVsLldlZWtJdGVtcy5mb3JFYWNoKChpdGVtOldlZWtJdGVtKT0+e1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpdGVtLlRpbWVJdGVtcy5mb3JFYWNoKChpdGVtMjpUaW1lSXRlbSk9PntcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW0yLlRocmVzaG9sZFR5cGUgPSBUaHJlc2hvbGRUeXBlLkhpZ2h0LnZhbHVlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudE1vZGVsLkRhdGVJdGVtcy5mb3JFYWNoKChpdGVtOkRhdGVJdGVtKT0+e1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpdGVtLlRpbWVJdGVtcy5mb3JFYWNoKChpdGVtMjpUaW1lSXRlbSk9PntcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW0yLlRocmVzaG9sZFR5cGUgPSBUaHJlc2hvbGRUeXBlLkhpZ2h0LnZhbHVlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMudGltZURyYXdNb2RlbC5hY3RpdmVUaW1lVHlwZSA9IFRocmVzaG9sZFR5cGUuSGlnaHQudmFsdWU7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy50aW1lRHJhd01vZGVsLmRyYXdCeVdlZWtJdGVtcyh0aGlzLmN1cnJlbnRNb2RlbC5XZWVrSXRlbXMpO1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMudGltZURyYXdNb2RlbC5kcmF3QnlEYXRlSXRlbXModGhpcy5jdXJyZW50TW9kZWwuRGF0ZUl0ZW1zKTtcclxuXHJcbiAgICAgICAgICAgICAgICB9Y2F0Y2ggKGUpe1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ0RhdGUgUGFyYW1zIGlzIEVycm9yJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy50aW1lRHJhd01vZGVsLnNoYXBlLmNsZWFyU2hhcGUoKTtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnRpbWVEcmF3TW9kZWwuZHJhd0J5V2Vla0l0ZW1zKFtdKTtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnRpbWVEcmF3TW9kZWwuZHJhd0J5RGF0ZUl0ZW1zKFtdKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8v5YWz6Zet56qX5Y+jXHJcbiAgICBjbG9zZVVwZGF0ZU1vZGVsKGlzRnJlc2g/OiBib29sZWFuLCBpdGVtTm9kZT86IFRpbWVUZW1wbGF0ZUV4KSB7XHJcbiAgICAgICAgdGhpcy4kc2NvcGUuJGVtaXQoJ2FkZC5ydW5wbGFuLnBvcHVwJywgaXNGcmVzaCwgaXRlbU5vZGUpO1xyXG4gICAgfVxyXG5cclxuXHJcbiAgICBhZGRDdXN0b21EYXlMaW5lKCkge1xyXG4gICAgICAgIHRoaXMudGltZURyYXdNb2RlbC5hZGRHcmlwTGluZSh0aGlzLmN1c3RvbVN0YXJ0RGF0ZSwgdGhpcy5jdXN0b21FbmREYXRlLCB0aGlzLmN1c3RvbUluZm8pO1xyXG4gICAgICAgIC8vICAgdGhpcy50aW1lRHJhd01vZGVsLnNoYXBlLnJlc2V0RHJhdygxKTtcclxuICAgIH07XHJcblxyXG4gICAgY29tbWl0U2F2ZU9yVXBkYXRlKCkge1xyXG4gICAgICAgIGxldCBkcmF3UmVzdWx0ID0gdGhpcy50aW1lRHJhd01vZGVsLmdldERyYXdBcmVhKCk7XHJcbiAgICAgICAgdGhpcy5jdXJyZW50TW9kZWwuRGF0ZUl0ZW1zID0gZHJhd1Jlc3VsdC5EYXRlSXRlbXM7XHJcbiAgICAgICAgdGhpcy5jdXJyZW50TW9kZWwuV2Vla0l0ZW1zID0gZHJhd1Jlc3VsdC5XZWVrSXRlbXM7XHJcblxyXG5cclxuICAgICAgICBpZiAoIXRoaXMudmFsaWRhdGUoKSkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBsZXQgdGVtcGxhdGVNb2RlbCA9IGFuZ3VsYXIuY29weSh0aGlzLmN1cnJlbnRNb2RlbCk7XHJcbiAgICAgICAgdGVtcGxhdGVNb2RlbC5DcmVhdGVUaW1lID0gRGF0ZS5ub3coKS50b1N0cmluZygpO1xyXG4gICAgICAgIHRlbXBsYXRlTW9kZWwuRGF5Q29udGVudCA9IGFuZ3VsYXIudG9Kc29uKHRoaXMuY3VycmVudE1vZGVsLkRhdGVJdGVtcyk7XHJcbiAgICAgICAgdGVtcGxhdGVNb2RlbC5XZWVrQ29udGVudCA9IGFuZ3VsYXIudG9Kc29uKHRoaXMuY3VycmVudE1vZGVsLldlZWtJdGVtcyk7XHJcbiAgICAgICAgdGVtcGxhdGVNb2RlbC5XZWVrSXRlbXMgPSBudWxsO1xyXG4gICAgICAgIHRlbXBsYXRlTW9kZWwuRGF0ZUl0ZW1zID0gbnVsbDtcclxuICAgICAgICB0ZW1wbGF0ZU1vZGVsLklzVGVtcGxhdGUgPSAhdGhpcy4kc2NvcGUuaXNUYXNrO1xyXG4gICAgICAgIGlmICh0aGlzLmlzVXBkYXRlKSB7XHJcbiAgICAgICAgICAgIHRoaXMudGltZVRlbXBsYXRlU2VydmljZS51cGRhdGUodGVtcGxhdGVNb2RlbCkudGhlbigocmVzcDogUmVzcG9uc2VSZXN1bHQ8c3RyaW5nPikgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKHJlc3AuY29kZSA9PT0gMjAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5jbG9zZVVwZGF0ZU1vZGVsKHRydWUsIHRlbXBsYXRlTW9kZWwpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aGlzLnRpbWVUZW1wbGF0ZVNlcnZpY2Uuc2F2ZSh0ZW1wbGF0ZU1vZGVsKS50aGVuKChyZXNwOiBSZXNwb25zZVJlc3VsdDxzdHJpbmc+KSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAocmVzcC5jb2RlID09PSAyMDApIHtcclxuICAgICAgICAgICAgICAgICAgICB0ZW1wbGF0ZU1vZGVsLklEID0gcmVzcC5kYXRhO1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuY2xvc2VVcGRhdGVNb2RlbCh0cnVlLCB0ZW1wbGF0ZU1vZGVsKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuXHJcbiAgICAvLy/lj4LmlbDpqozor4FcclxuICAgIHZhbGlkYXRlKCk6IGJvb2xlYW4ge1xyXG4gICAgICAgIGlmICghdGhpcy5jdXJyZW50TW9kZWwuTmFtZSkge1xyXG4gICAgICAgICAgICB0aGlzLmxheWVyRGVjLndhcm5JbmZvKFwi5pyq5aGr5YaZ5pe26Ze05qih5p2/5ZCN56ew77yBXCIpO1xyXG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGxldCBoYXNUaW1lSXRlbSA9IGZhbHNlO1xyXG4gICAgICAgIGFuZ3VsYXIuZm9yRWFjaCh0aGlzLmN1cnJlbnRNb2RlbC5XZWVrSXRlbXMsICh2YWw6IFdlZWtJdGVtKSA9PiB7XHJcbiAgICAgICAgICAgIGlmICh2YWwuVGltZUl0ZW1zICYmIHZhbC5UaW1lSXRlbXMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICAgICAgaGFzVGltZUl0ZW0gPSB0cnVlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGlmICghaGFzVGltZUl0ZW0gJiYgdGhpcy5jdXJyZW50TW9kZWwuRGF0ZUl0ZW1zLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICAgICAgICB0aGlzLmxheWVyRGVjLndhcm5JbmZvKFwi5pyq5YGa5pe26Ze05qih5p2/5pe26Ze06YCJ5oup77yBXCIpO1xyXG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgfTtcclxuXHJcbn1cclxuXHJcbmFwcC5jb250cm9sbGVyKCdydW5QbGFuUG9wdXBDb250cm9sbGVyJywgUnVuUGxhblBvcHVwQ29udHJvbGxlcik7XHJcbiJdfQ==
