define(["require", "exports", "../../common/app/main.app", "../../common/directive/tree/tree-params", "../../../core/enum/TreeType", "../../../core/enum/ObjectType", "../../common/directive/tree/tree.directive.service", "../../common/services/connectTree.service", "../../common/factory/layerMsg.factory"], function (require, exports, main_app_1, tree_params_1, TreeType_1, ObjectType_1) {
    "use strict";
    Object.defineProperty(exports, "__esModule", { value: true });
    var RmpgatePopupController = (function () {
        function RmpgatePopupController($scope, areaService, $timeout, rmpgateService, treeService, connectTreeService, layerDec) {
            this.$scope = $scope;
            this.areaService = areaService;
            this.$timeout = $timeout;
            this.rmpgateService = rmpgateService;
            this.treeService = treeService;
            this.connectTreeService = connectTreeService;
            this.layerDec = layerDec;
            this.cacheChangeNodes = {};
            this.type = $scope.type;
            this.rightSelectTreeNodeId = null;
            this.initTreeParams();
            this.getLeftTreeData();
            this.getRightTreeData();
        }
        RmpgatePopupController.prototype.initTreeParams = function () {
            var _this = this;
            this.leftTreeParams = new tree_params_1.TreeDataParams(true);
            this.leftTreeParams.treeId = "devicePopupLeftTree";
            this.leftTreeParams.isShowIcon = true;
            this.leftTreeParams.isShowLine = false;
            this.leftTreeParams.isSimpleData = true;
            this.leftTreeParams.checkEnable = false;
            this.leftTreeParams.isSingleSelect = false;
            this.leftTreeParams.editEnable = true;
            this.leftTreeParams.showRemoveBtn = false;
            this.leftTreeParams.showRenameBtn = false;
            this.leftTreeParams.beforeDrop = beforeDropRule;
            this.leftTreeParams.beforeDrag = beforeDragRule;
            if (this.type === TreeType_1.TreeType.lamp.value) {
                this.leftTreeParams.addDiyDom = function (treeId, treeNode) {
                    _this.treeService.addDiyDomIsConfiStatus(treeId, treeNode);
                };
            }
            this.rightTreeParams = new tree_params_1.TreeDataParams(true);
            this.rightTreeParams.treeId = "devicePopupRightTree";
            this.rightTreeParams.isShowIcon = true;
            this.rightTreeParams.isShowLine = false;
            this.rightTreeParams.isSimpleData = true;
            this.rightTreeParams.checkEnable = false;
            this.rightTreeParams.isSingleSelect = false;
            this.rightTreeParams.editEnable = true;
            this.rightTreeParams.showRemoveBtn = false;
            this.rightTreeParams.showRenameBtn = false;
            this.rightTreeParams.beforeDrop = beforeDropRule;
            this.rightTreeParams.beforeDrag = beforeDragRule;
            var _self = this;
            function beforeDropRule(treeId, treeNodes, targetNode) {
                if (treeId == _self.leftTreeParams.treeId) {
                    return false;
                }
                if (_self.type === TreeType_1.TreeType.lamp.value && targetNode.treeType !== TreeType_1.TreeType.lamp.value) {
                    return false;
                }
                if (_self.type === TreeType_1.TreeType.area.value && targetNode.treeType !== TreeType_1.TreeType.area.value) {
                    return false;
                }
                var newNodeList = [];
                var updateNodeList = [];
                treeNodes.forEach(function (item) {
                    item.ParentID = targetNode.ID;
                    item.isConfigLamp = true;
                    var node = _self.treeService.getNodeByParam(treeId, 'ID', item.ID);
                    if (node) {
                        updateNodeList.push(item);
                    }
                    else {
                        newNodeList.push(item);
                    }
                });
                if (updateNodeList.length > 0) {
                    _self.$timeout(function () {
                        _self.treeService.removeNodes(treeId, updateNodeList);
                        _self.treeService.addNodes(treeId, updateNodeList, targetNode);
                    });
                }
                if (newNodeList.length > 0) {
                    _self.treeService.addNodes(treeId, newNodeList, targetNode);
                }
                if (_self.type === TreeType_1.TreeType.lamp.value) {
                    _self.updateTreeDiyDom(treeId, treeNodes);
                }
                _self.changeNodesParentID(treeNodes, targetNode.ID);
                return false;
            }
            function beforeDragRule(treeId, treeNodes) {
                var flag = true;
                if (treeNodes && treeNodes.length > 0) {
                    var i = void 0, len = void 0, treeType = TreeType_1.TreeType.rmpGate.value;
                    for (i = 0, len = treeNodes.length; i < len; i++) {
                        if (treeNodes[i].treeType !== treeType) {
                            flag = false;
                            break;
                        }
                    }
                }
                else {
                    flag = false;
                }
                return flag;
            }
        };
        RmpgatePopupController.prototype.updateTreeDiyDom = function (treeId, treeNodes) {
            var _this = this;
            this.$timeout(function () {
                treeNodes.forEach(function (item) {
                    console.log(item);
                    _this.leftTreeParams.addDiyDom(treeId, item);
                });
            });
        };
        RmpgatePopupController.prototype.changeNodesParentID = function (treeNodes, parentId) {
            if (!treeNodes || treeNodes.length <= 0)
                return;
            var i, len, temp, originParentId;
            for (i = 0, len = treeNodes.length; i < len; i++) {
                if (this.type === TreeType_1.TreeType.area.value) {
                    temp = treeNodes[i];
                    originParentId = temp.AreaID;
                    temp.ParentID = parentId;
                    temp.AreaID = parentId;
                }
                else if (this.type === TreeType_1.TreeType.lamp.value) {
                    temp = treeNodes[i];
                    if (!temp.JsonUserData.lampPost) {
                        var lampPost = {};
                        lampPost.ObjectId = parentId;
                        lampPost.ObjectType = ObjectType_1.ObjectType.LampPost.value;
                        lampPost.RelatedObjectId = temp.ID;
                        lampPost.RelatedObjectType = ObjectType_1.ObjectType.RmpGate.value;
                        temp.JsonUserData.lampPost = lampPost;
                        originParentId = "";
                        temp.ParentID = parentId;
                    }
                    else {
                        originParentId = temp.JsonUserData.lampPost.ID;
                        temp.ParentID = parentId;
                        temp.JsonUserData.lampPost.ID = parentId;
                    }
                }
                this.addOrUpdateTreeChangeCache({ id: temp.ID, parentId: temp.ParentID, originParentId: originParentId, deviceReId: temp.JsonUserData.DeviceReId });
            }
        };
        RmpgatePopupController.prototype.addOrUpdateTreeChangeCache = function (model) {
            if (this.cacheChangeNodes[model.id]) {
                this.cacheChangeNodes[model.id].parentId = model.parentId;
            }
            else {
                this.cacheChangeNodes[model.id] = model;
            }
        };
        RmpgatePopupController.prototype.submit = function () {
            var _this = this;
            var key, temp, models = [], P;
            if (this.type === 'area') {
                for (key in this.cacheChangeNodes) {
                    temp = this.cacheChangeNodes[key];
                    models.push({ id: temp.id, areaId: temp.parentId });
                }
                if (models.length > 0) {
                    P = this.rmpgateService.updateRmpGateAreaID(models);
                }
                else {
                    this.layerDec.warnInfo("没有选择任何区域");
                    this.cancel(false);
                }
            }
            else {
                for (key in this.cacheChangeNodes) {
                    temp = this.cacheChangeNodes[key];
                    models.push({ id: temp.id, lampId: temp.parentId, deviceReId: temp.deviceReId });
                }
                if (models.length > 0) {
                    P = this.rmpgateService.updateRmpGateLampID(models);
                }
                else {
                    this.layerDec.warnInfo("没有选择任何立杆");
                    this.cancel(false);
                }
            }
            if (P) {
                P.then(function (res) {
                    if (res && res.code === 200) {
                        _this.cancel(true);
                    }
                    else {
                        console.error("rmpgateService.updateRmpGateAreaID error", res);
                    }
                });
            }
        };
        RmpgatePopupController.prototype.cancel = function (flag) {
            this.$scope.$emit('device.closePopup', flag);
        };
        RmpgatePopupController.prototype.getLeftTreeData = function () {
            var _this = this;
            this.rmpgateService.findAll().then(function (res) {
                _this.$timeout(function () {
                    _this.leftTreeParams.treeDatas = res;
                });
            });
        };
        RmpgatePopupController.prototype.getRightTreeData = function () {
            var _this = this;
            var P;
            if (this.type === 'lamp') {
                P = this.connectTreeService.findLampTreeWithRmpGate();
            }
            else {
                P = this.connectTreeService.findAreaWithRmpgate();
            }
            P.then(function (datas) {
                _this.$timeout(function () {
                    _this.rightTreeParams.treeDatas = datas;
                });
            });
        };
        RmpgatePopupController.$inject = ['$scope', 'areaService', '$timeout', 'rmpgateService', 'treeDirectiveService', 'connectTreeService', 'layerDec'];
        return RmpgatePopupController;
    }());
    main_app_1.app.controller("baseConfigRmpgatePopup", RmpgatePopupController);
});

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNyYy9tb2R1bGUvYmFzZWNvbmZpZy9ybXBnYXRlL3JtcGdhdGUucG9wdXBSbXBHYXRlLmNvbnRyb2xsZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0lBa0NBO1FBT0ksZ0NBQ1ksTUFBVyxFQUFVLFdBQXlCLEVBQzlDLFFBQWEsRUFBVSxjQUErQixFQUN0RCxXQUFrQyxFQUNsQyxrQkFBdUMsRUFDdkMsUUFBa0I7WUFKbEIsV0FBTSxHQUFOLE1BQU0sQ0FBSztZQUFVLGdCQUFXLEdBQVgsV0FBVyxDQUFjO1lBQzlDLGFBQVEsR0FBUixRQUFRLENBQUs7WUFBVSxtQkFBYyxHQUFkLGNBQWMsQ0FBaUI7WUFDdEQsZ0JBQVcsR0FBWCxXQUFXLENBQXVCO1lBQ2xDLHVCQUFrQixHQUFsQixrQkFBa0IsQ0FBcUI7WUFDdkMsYUFBUSxHQUFSLFFBQVEsQ0FBVTtZQU45QixxQkFBZ0IsR0FBRyxFQUEyQixDQUFDO1lBUTNDLElBQUksQ0FBQyxJQUFJLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQztZQUN4QixJQUFJLENBQUMscUJBQXFCLEdBQUcsSUFBSSxDQUFDO1lBQ2xDLElBQUksQ0FBQyxjQUFjLEVBQUUsQ0FBQztZQUN0QixJQUFJLENBQUMsZUFBZSxFQUFFLENBQUM7WUFDdkIsSUFBSSxDQUFDLGdCQUFnQixFQUFFLENBQUM7UUFDNUIsQ0FBQztRQUNPLCtDQUFjLEdBQXRCO1lBQUEsaUJBcUZDO1lBcEZHLElBQUksQ0FBQyxjQUFjLEdBQUcsSUFBSSw0QkFBYyxDQUFZLElBQUksQ0FBQyxDQUFDO1lBQzFELElBQUksQ0FBQyxjQUFjLENBQUMsTUFBTSxHQUFHLHFCQUFxQixDQUFDO1lBQ25ELElBQUksQ0FBQyxjQUFjLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQztZQUN0QyxJQUFJLENBQUMsY0FBYyxDQUFDLFVBQVUsR0FBRyxLQUFLLENBQUM7WUFDdkMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDO1lBQ3hDLElB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QUFDLENBQUMsQ0FBQztZQUNQLENBQUMsQ0FBQyxDQUFDO1FBQ1AsQ0FBQztRQUNPLGlEQUFnQixHQUF4QjtZQUFBLGlCQWFDO1lBWkcsSUFBSSxDQUFNLENBQUM7WUFDWCxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxLQUFLLE1BQU0sQ0FBQyxDQUFDLENBQUM7Z0JBQ3ZCLENBQUMsR0FBRyxJQUFJLENBQUMsa0JBQWtCLENBQUMsdUJBQXVCLEVBQUUsQ0FBQTtZQUN6RCxDQUFDO1lBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQ0osQ0FBQyxHQUFHLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxtQkFBbUIsRUFBRSxDQUFBO1lBQ3JELENBQUM7WUFFRCxDQUFDLENBQUMsSUFBSSxDQUFDLFVBQUMsS0FBaUI7Z0JBQ3JCLEtBQUksQ0FBQyxRQUFRLENBQUM7b0JBQ1YsS0FBSSxDQUFDLGVBQWUsQ0FBQyxTQUFTLEdBQUcsS0FBSyxDQUFDO2dCQUMzQyxDQUFDLENBQUMsQ0FBQztZQUNQLENBQUMsQ0FBQyxDQUFBO1FBQ04sQ0FBQztRQXhOTSw4QkFBTyxHQUFHLENBQUMsUUFBUSxFQUFFLGFBQWEsRUFBRSxVQUFVLEVBQUUsZ0JBQWdCLEVBQUUsc0JBQXNCLEVBQUUsb0JBQW9CLEVBQUMsVUFBVSxDQUFDLENBQUM7UUF5TnRJLDZCQUFDO0tBMU5ELEFBME5DLElBQUE7SUFFRCxjQUFHLENBQUMsVUFBVSxDQUFDLHdCQUF3QixFQUFFLHNCQUFzQixDQUFDLENBQUMiLCJmaWxlIjoibW9kdWxlL2Jhc2Vjb25maWcvcm1wZ2F0ZS9ybXBnYXRlLnBvcHVwUm1wR2F0ZS5jb250cm9sbGVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgYXBwIH0gZnJvbSBcIi4uLy4uL2NvbW1vbi9hcHAvbWFpbi5hcHBcIjtcclxuaW1wb3J0IHsgVHJlZURhdGFQYXJhbXMgfSBmcm9tIFwiLi4vLi4vY29tbW9uL2RpcmVjdGl2ZS90cmVlL3RyZWUtcGFyYW1zXCI7XHJcbmltcG9ydCB7IFJtcEdhdGUgfSBmcm9tIFwiLi4vLi4vLi4vY29yZS9lbnRpdHkvUm1wR2F0ZVwiO1xyXG5pbXBvcnQgeyBJQXJlYVNlcnZpY2UgfSBmcm9tIFwiLi4vLi4vY29tbW9uL3NlcnZpY2VzL2FyZWEuc2VydmljZVwiO1xyXG5pbXBvcnQgeyBSbXBHYXRlRXggfSBmcm9tIFwiLi4vLi4vLi4vY29yZS9lbnRpdHkvZXgvUm1wR2F0ZUV4XCI7XHJcbmltcG9ydCB7IEFyZWFFeCB9IGZyb20gXCIuLi8uLi8uLi9jb3JlL2VudGl0eS9leC9BcmVhRXhcIjtcclxuaW1wb3J0IHsgTGFtcEV4IH0gZnJvbSBcIi4uLy4uLy4uL2NvcmUvZW50aXR5L2V4L0xhbXBFeFwiO1xyXG5pbXBvcnQgeyBJUm1wR2F0ZVNlcnZpY2UgfSBmcm9tIFwiLi4vLi4vY29tbW9uL3NlcnZpY2VzL3JtcGdhdGUuc2VydmljZVwiO1xyXG5pbXBvcnQgXCIuLi8uLi9jb21tb24vZGlyZWN0aXZlL3RyZWUvdHJlZS5kaXJlY3RpdmUuc2VydmljZVwiO1xyXG5pbXBvcnQgeyBJVHJlZURpcmVjdGl2ZVNlcnZpY2UgfSBmcm9tIFwiLi4vLi4vY29tbW9uL2RpcmVjdGl2ZS90cmVlL3RyZWUuZGlyZWN0aXZlLnNlcnZpY2VcIjtcclxuaW1wb3J0IHsgUm1wR2F0ZUNoYW5nZUFyZWFJRE1vZGVsIH0gZnJvbSBcIi4uLy4uLy4uL2NvcmUvcGFyYW1zL1JtcEdhdGVQYXJhbXNcIjtcclxuaW1wb3J0IHsgUmVzcG9uc2VSZXN1bHQgfSBmcm9tIFwiLi4vLi4vLi4vY29yZS9wYXJhbXMvcmVzdWx0L1Jlc3BvbnNlUmVzdWx0XCI7XHJcbmltcG9ydCB7IFRyZWVUeXBlIH0gZnJvbSBcIi4uLy4uLy4uL2NvcmUvZW51bS9UcmVlVHlwZVwiO1xyXG5pbXBvcnQgeyBJQ29ubmVjdFRyZWVTZXJ2aWNlIH0gZnJvbSBcIi4uLy4uL2NvbW1vbi9zZXJ2aWNlcy9jb25uZWN0VHJlZS5zZXJ2aWNlXCI7XHJcbmltcG9ydCBcIi4uLy4uL2NvbW1vbi9zZXJ2aWNlcy9jb25uZWN0VHJlZS5zZXJ2aWNlXCI7XHJcblxyXG5pbXBvcnQgeyBSZWxhdGlvbiB9IGZyb20gJy4uLy4uLy4uL2NvcmUvZW50aXR5L0RldmljZVJlbGF0aW9uJztcclxuaW1wb3J0IHtPYmplY3RUeXBlfSBmcm9tIFwiLi4vLi4vLi4vY29yZS9lbnVtL09iamVjdFR5cGVcIjtcclxuaW1wb3J0IHtJTGF5ZXJEZWN9IGZyb20gXCIuLi8uLi9jb21tb24vZmFjdG9yeS9sYXllck1zZy5mYWN0b3J5XCI7XHJcbmltcG9ydCAgXCIuLi8uLi9jb21tb24vZmFjdG9yeS9sYXllck1zZy5mYWN0b3J5XCI7XHJcbnR5cGUgQXJlYVJtcEdhdGVFeCA9IEFyZWFFeCAmIFJtcEdhdGVFeDtcclxuXHJcbmludGVyZmFjZSBBcmVhSURDYWNoZU1vZGVsIHtcclxuICAgIGlkOiBzdHJpbmc7XHJcbiAgICBwYXJlbnRJZDogc3RyaW5nO1xyXG4gICAgb3JpZ2luUGFyZW50SWQ6IHN0cmluZztcclxuICAgIGRldmljZVJlSWQ/OiBzdHJpbmc7XHJcbn1cclxuXHJcbmludGVyZmFjZSBBcmVhSURDYWNoZUNvbGxlY3Rpb24ge1xyXG4gICAgW2tleTogc3RyaW5nXTogQXJlYUlEQ2FjaGVNb2RlbDtcclxufVxyXG5cclxuXHJcbmNsYXNzIFJtcGdhdGVQb3B1cENvbnRyb2xsZXIge1xyXG4gICAgc3RhdGljICRpbmplY3QgPSBbJyRzY29wZScsICdhcmVhU2VydmljZScsICckdGltZW91dCcsICdybXBnYXRlU2VydmljZScsICd0cmVlRGlyZWN0aXZlU2VydmljZScsICdjb25uZWN0VHJlZVNlcnZpY2UnLCdsYXllckRlYyddO1xyXG4gICAgcmlnaHRTZWxlY3RUcmVlTm9kZUlkOiBzdHJpbmc7XHJcbiAgICBsZWZ0VHJlZVBhcmFtczogVHJlZURhdGFQYXJhbXM8Um1wR2F0ZT47XHJcbiAgICByaWdodFRyZWVQYXJhbXM6IFRyZWVEYXRhUGFyYW1zPGFueT47XHJcbiAgICB0eXBlOiBzdHJpbmc7XHJcbiAgICBjYWNoZUNoYW5nZU5vZGVzID0ge30gYXMgQXJlYUlEQ2FjaGVDb2xsZWN0aW9uO1xyXG4gICAgY29uc3RydWN0b3IoXHJcbiAgICAgICAgcHJpdmF0ZSAkc2NvcGU6IGFueSwgcHJpdmF0ZSBhcmVhU2VydmljZTogSUFyZWFTZXJ2aWNlLFxyXG4gICAgICAgIHByaXZhdGUgJHRpbWVvdXQ6IGFueSwgcHJpdmF0ZSBybXBnYXRlU2VydmljZTogSVJtcEdhdGVTZXJ2aWNlLFxyXG4gICAgICAgIHByaXZhdGUgdHJlZVNlcnZpY2U6IElUcmVlRGlyZWN0aXZlU2VydmljZSxcclxuICAgICAgICBwcml2YXRlIGNvbm5lY3RUcmVlU2VydmljZTogSUNvbm5lY3RUcmVlU2VydmljZSxcclxuICAgICAgICBwcml2YXRlIGxheWVyRGVjOklMYXllckRlY1xyXG4gICAgKSB7XHJcbiAgICAgICAgdGhpcy50eXBlID0gJHNjb3BlLnR5cGU7XHJcbiAgICAgICAgdGhpcy5yaWdodFNlbGVjdFRyZWVOb2RlSWQgPSBudWxsO1xyXG4gICAgICAgIHRoaXMuaW5pdFRyZWVQYXJhbXMoKTtcclxuICAgICAgICB0aGlzLmdldExlZnRUcmVlRGF0YSgpO1xyXG4gICAgICAgIHRoaXMuZ2V0UmlnaHRUcmVlRGF0YSgpO1xyXG4gICAgfVxyXG4gICAgcHJpdmF0ZSBpbml0VHJlZVBhcmFtcygpIHtcclxuICAgICAgICB0aGlzLmxlZnRUcmVlUGFyYW1zID0gbmV3IFRyZWVEYXRhUGFyYW1zPFJtcEdhdGVFeD4odHJ1ZSk7XHJcbiAgICAgICAgdGhpcy5sZWZ0VHJlZVBhcmFtcy50cmVlSWQgPSBcImRldmljZVBvcHVwTGVmdFRyZWVcIjtcclxuICAgICAgICB0aGlzLmxlZnRUcmVlUGFyYW1zLmlzU2hvd0ljb24gPSB0cnVlO1xyXG4gICAgICAgIHRoaXMubGVmdFRyZWVQYXJhbXMuaXNTaG93TGluZSA9IGZhbHNlO1xyXG4gICAgICAgIHRoaXMubGVmdFRyZWVQYXJhbXMuaXNTaW1wbGVEYXRhID0gdHJ1ZTtcclxuICAgICAgICB0aGlzLmxlZnRUcmVlUGFyYW1zLmNoZWNrRW5hYmxlID0gZmFsc2U7XHJcbiAgICAgICAgdGhpcy5sZWZ0VHJlZVBhcmFtcy5pc1NpbmdsZVNlbGVjdCA9IGZhbHNlO1xyXG4gICAgICAgIHRoaXMubGVmdFRyZWVQYXJhbXMuZWRpdEVuYWJsZSA9IHRydWU7XHJcbiAgICAgICAgdGhpcy5sZWZ0VHJlZVBhcmFtcy5zaG93UmVtb3ZlQnRuID0gZmFsc2U7XHJcbiAgICAgICAgdGhpcy5sZWZ0VHJlZVBhcmFtcy5zaG93UmVuYW1lQnRuID0gZmFsc2U7XHJcbiAgICAgICAgdGhpcy5sZWZ0VHJlZVBhcmFtcy5iZWZvcmVEcm9wID0gYmVmb3JlRHJvcFJ1bGU7XHJcbiAgICAgICAgdGhpcy5sZWZ0VHJlZVBhcmFtcy5iZWZvcmVEcmFnID0gYmVmb3JlRHJhZ1J1bGU7XHJcbiAgICAgICAgaWYodGhpcy50eXBlID09PSBUcmVlVHlwZS5sYW1wLnZhbHVlKXtcclxuICAgICAgICAgICAgdGhpcy5sZWZ0VHJlZVBhcmFtcy5hZGREaXlEb20gPSAodHJlZUlkOiBzdHJpbmcsIHRyZWVOb2RlOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgICAgIHRoaXMudHJlZVNlcnZpY2UuYWRkRGl5RG9tSXNDb25maVN0YXR1cyh0cmVlSWQsIHRyZWVOb2RlKTtcclxuICAgICAgICAgICAgfTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRoaXMucmlnaHRUcmVlUGFyYW1zID0gbmV3IFRyZWVEYXRhUGFyYW1zPEFyZWFSbXBHYXRlRXg+KHRydWUpO1xyXG4gICAgICAgIHRoaXMucmlnaHRUcmVlUGFyYW1zLnRyZWVJZCA9IFwiZGV2aWNlUG9wdXBSaWdodFRyZWVcIjtcclxuICAgICAgICB0aGlzLnJpZ2h0VHJlZVBhcmFtcy5pc1Nob3dJY29uID0gdHJ1ZTtcclxuICAgICAgICB0aGlzLnJpZ2h0VHJlZVBhcmFtcy5pc1Nob3dMaW5lID0gZmFsc2U7XHJcbiAgICAgICAgdGhpcy5yaWdodFRyZWVQYXJhbXMuaXNTaW1wbGVEYXRhID0gdHJ1ZTtcclxuICAgICAgICB0aGlzLnJpZ2h0VHJlZVBhcmFtcy5jaGVja0VuYWJsZSA9IGZhbHNlO1xyXG4gICAgICAgIHRoaXMucmlnaHRUcmVlUGFyYW1zLmlzU2luZ2xlU2VsZWN0ID0gZmFsc2U7XHJcbiAgICAgICAgdGhpcy5yaWdodFRyZWVQYXJhbXMuZWRpdEVuYWJsZSA9IHRydWU7XHJcbiAgICAgICAgdGhpcy5yaWdodFRyZWVQYXJhbXMuc2hvd1JlbW92ZUJ0biA9IGZhbHNlO1xyXG4gICAgICAgIHRoaXMucmlnaHRUcmVlUGFyYW1zLnNob3dSZW5hbWVCdG4gPSBmYWxzZTtcclxuICAgICAgICB0aGlzLnJpZ2h0VHJlZVBhcmFtcy5iZWZvcmVEcm9wID0gYmVmb3JlRHJvcFJ1bGU7XHJcbiAgICAgICAgdGhpcy5yaWdodFRyZWVQYXJhbXMuYmVmb3JlRHJhZyA9IGJlZm9yZURyYWdSdWxlO1xyXG4gICAgICAgIGxldCBfc2VsZiA9IHRoaXMgYXMgUm1wZ2F0ZVBvcHVwQ29udHJvbGxlcjtcclxuICAgICAgICBmdW5jdGlvbiBiZWZvcmVEcm9wUnVsZSggdHJlZUlkOiBzdHJpbmcsIHRyZWVOb2RlczogQXJyYXk8Um1wR2F0ZUV4PiwgdGFyZ2V0Tm9kZTogTGFtcEV4ICYgQXJlYUV4ICYgUm1wR2F0ZUV4KSB7XHJcbiAgICAgICAgICAgIGlmICh0cmVlSWQgPT0gX3NlbGYubGVmdFRyZWVQYXJhbXMudHJlZUlkKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKF9zZWxmLnR5cGUgPT09IFRyZWVUeXBlLmxhbXAudmFsdWUgJiYgdGFyZ2V0Tm9kZS50cmVlVHlwZSAhPT0gVHJlZVR5cGUubGFtcC52YWx1ZSkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmIChfc2VsZi50eXBlID09PSBUcmVlVHlwZS5hcmVhLnZhbHVlICYmIHRhcmdldE5vZGUudHJlZVR5cGUgIT09IFRyZWVUeXBlLmFyZWEudmFsdWUpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBsZXQgbmV3Tm9kZUxpc3QgPSBbXSBhcyBBcnJheTxSbXBHYXRlRXg+O1xyXG4gICAgICAgICAgICBsZXQgdXBkYXRlTm9kZUxpc3QgPSBbXSBhcyBBcnJheTxSbXBHYXRlRXg+O1xyXG4gICAgICAgICAgICB0cmVlTm9kZXMuZm9yRWFjaCgoaXRlbTogUm1wR2F0ZUV4IHwgYW55KSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpdGVtLlBhcmVudElEID0gdGFyZ2V0Tm9kZS5JRDtcclxuICAgICAgICAgICAgICAgIGl0ZW0uaXNDb25maWdMYW1wID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgIGxldCBub2RlID0gX3NlbGYudHJlZVNlcnZpY2UuZ2V0Tm9kZUJ5UGFyYW0odHJlZUlkLCAnSUQnLCBpdGVtLklEKSBhcyBSbXBHYXRlRXg7XHJcbiAgICAgICAgICAgICAgICBpZiAobm9kZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHVwZGF0ZU5vZGVMaXN0LnB1c2goaXRlbSlcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbmV3Tm9kZUxpc3QucHVzaChpdGVtKVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgaWYgKHVwZGF0ZU5vZGVMaXN0Lmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgICAgIF9zZWxmLiR0aW1lb3V0KCgpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBfc2VsZi50cmVlU2VydmljZS5yZW1vdmVOb2Rlcyh0cmVlSWQsIHVwZGF0ZU5vZGVMaXN0KTtcclxuICAgICAgICAgICAgICAgICAgICBfc2VsZi50cmVlU2VydmljZS5hZGROb2Rlcyh0cmVlSWQsIHVwZGF0ZU5vZGVMaXN0LCB0YXJnZXROb2RlKTtcclxuICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKG5ld05vZGVMaXN0Lmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgICAgIF9zZWxmLnRyZWVTZXJ2aWNlLmFkZE5vZGVzKHRyZWVJZCwgbmV3Tm9kZUxpc3QsIHRhcmdldE5vZGUpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmKF9zZWxmLnR5cGUgPT09IFRyZWVUeXBlLmxhbXAudmFsdWUpe1xyXG4gICAgICAgICAgICAgICAgX3NlbGYudXBkYXRlVHJlZURpeURvbSh0cmVlSWQsIHRyZWVOb2Rlcyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgX3NlbGYuY2hhbmdlTm9kZXNQYXJlbnRJRCh0cmVlTm9kZXMsIHRhcmdldE5vZGUuSUQpO1xyXG4gICAgICAgICAgICByZXR1cm4gZmFsc2VcclxuXHJcbiAgICAgICAgfVxyXG4gICAgICAgIGZ1bmN0aW9uIGJlZm9yZURyYWdSdWxlKHRyZWVJZDogc3RyaW5nLCB0cmVlTm9kZXM6IEFycmF5PFJtcEdhdGVFeD4pIHtcclxuICAgICAgICAgICAgbGV0IGZsYWcgPSB0cnVlO1xyXG4gICAgICAgICAgICBpZiAodHJlZU5vZGVzICYmIHRyZWVOb2Rlcy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgICAgICBsZXQgaSwgbGVuLCB0cmVlVHlwZSA9IFRyZWVUeXBlLnJtcEdhdGUudmFsdWU7XHJcbiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwLCBsZW4gPSB0cmVlTm9kZXMubGVuZ3RoOyBpIDwgbGVuOyBpKyspIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAodHJlZU5vZGVzW2ldLnRyZWVUeXBlICE9PSB0cmVlVHlwZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBmbGFnID0gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGZsYWcgPSBmYWxzZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gZmxhZztcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICAvKipcclxuICAgICAqIEBkZXNjIOaJuemHj+WOu+abtOaWsGRpeURvbeeKtuaAgVxyXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IHRyZWVJZFxyXG4gICAgICogQHBhcmFtIHtBcnJheTxhbnk+fSB0cmVlTm9kZXNcclxuICAgICAqL1xyXG4gICAgdXBkYXRlVHJlZURpeURvbSh0cmVlSWQ6IHN0cmluZywgdHJlZU5vZGVzOiBBcnJheTxhbnk+KSB7XHJcbiAgICAgICAgdGhpcy4kdGltZW91dCgoKSA9PiB7XHJcbiAgICAgICAgICAgIHRyZWVOb2Rlcy5mb3JFYWNoKChpdGVtOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGl0ZW0pXHJcbiAgICAgICAgICAgICAgICB0aGlzLmxlZnRUcmVlUGFyYW1zLmFkZERpeURvbSh0cmVlSWQsIGl0ZW0pO1xyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgIH0pXHJcbiAgICB9XHJcbiAgICBwcml2YXRlIGNoYW5nZU5vZGVzUGFyZW50SUQodHJlZU5vZGVzOiBhbnksIHBhcmVudElkOiBzdHJpbmcpIHtcclxuICAgICAgICBpZiAoIXRyZWVOb2RlcyB8fCB0cmVlTm9kZXMubGVuZ3RoIDw9IDApIHJldHVybjtcclxuICAgICAgICBsZXQgaSwgbGVuLCB0ZW1wLCBvcmlnaW5QYXJlbnRJZDtcclxuICAgICAgICBmb3IgKGkgPSAwLCBsZW4gPSB0cmVlTm9kZXMubGVuZ3RoOyBpIDwgbGVuOyBpKyspIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMudHlwZSA9PT0gVHJlZVR5cGUuYXJlYS52YWx1ZSkge1xyXG4gICAgICAgICAgICAgICAgdGVtcCA9IHRyZWVOb2Rlc1tpXTtcclxuICAgICAgICAgICAgICAgIG9yaWdpblBhcmVudElkID0gdGVtcC5BcmVhSUQ7XHJcbiAgICAgICAgICAgICAgICB0ZW1wLlBhcmVudElEID0gcGFyZW50SWQ7XHJcbiAgICAgICAgICAgICAgICB0ZW1wLkFyZWFJRCA9IHBhcmVudElkO1xyXG4gICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMudHlwZSA9PT0gVHJlZVR5cGUubGFtcC52YWx1ZSkge1xyXG4gICAgICAgICAgICAgICAgdGVtcCA9IHRyZWVOb2Rlc1tpXTtcclxuICAgICAgICAgICAgICAgIGlmICghdGVtcC5Kc29uVXNlckRhdGEubGFtcFBvc3QpIHtcclxuICAgICAgICAgICAgICAgICAgICBsZXQgbGFtcFBvc3QgPSB7fSBhcyBSZWxhdGlvbjtcclxuICAgICAgICAgICAgICAgICAgICBsYW1wUG9zdC5PYmplY3RJZCA9IHBhcmVudElkO1xyXG4gICAgICAgICAgICAgICAgICAgIGxhbXBQb3N0Lk9iamVjdFR5cGUgPSBPYmplY3RUeXBlLkxhbXBQb3N0LnZhbHVlO1xyXG4gICAgICAgICAgICAgICAgICAgIGxhbXBQb3N0LlJlbGF0ZWRPYmplY3RJZCA9IHRlbXAuSUQ7XHJcbiAgICAgICAgICAgICAgICAgICAgbGFtcFBvc3QuUmVsYXRlZE9iamVjdFR5cGUgPSBPYmplY3RUeXBlLlJtcEdhdGUudmFsdWU7XHJcbiAgICAgICAgICAgICAgICAgICAgdGVtcC5Kc29uVXNlckRhdGEubGFtcFBvc3QgPSBsYW1wUG9zdDtcclxuICAgICAgICAgICAgICAgICAgICBvcmlnaW5QYXJlbnRJZCA9IFwiXCI7XHJcbiAgICAgICAgICAgICAgICAgICAgdGVtcC5QYXJlbnRJRCA9IHBhcmVudElkO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICBvcmlnaW5QYXJlbnRJZCA9IHRlbXAuSnNvblVzZXJEYXRhLmxhbXBQb3N0LklEO1xyXG4gICAgICAgICAgICAgICAgICAgIHRlbXAuUGFyZW50SUQgPSBwYXJlbnRJZDtcclxuICAgICAgICAgICAgICAgICAgICB0ZW1wLkpzb25Vc2VyRGF0YS5sYW1wUG9zdC5JRCA9IHBhcmVudElkO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgdGhpcy5hZGRPclVwZGF0ZVRyZWVDaGFuZ2VDYWNoZSh7IGlkOiB0ZW1wLklELCBwYXJlbnRJZDogdGVtcC5QYXJlbnRJRCwgb3JpZ2luUGFyZW50SWQ6IG9yaWdpblBhcmVudElkLCBkZXZpY2VSZUlkOiB0ZW1wLkpzb25Vc2VyRGF0YS5EZXZpY2VSZUlkIH0pO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIHByaXZhdGUgYWRkT3JVcGRhdGVUcmVlQ2hhbmdlQ2FjaGUobW9kZWw6IEFyZWFJRENhY2hlTW9kZWwpIHtcclxuICAgICAgICBpZiAodGhpcy5jYWNoZUNoYW5nZU5vZGVzW21vZGVsLmlkXSkge1xyXG4gICAgICAgICAgICB0aGlzLmNhY2hlQ2hhbmdlTm9kZXNbbW9kZWwuaWRdLnBhcmVudElkID0gbW9kZWwucGFyZW50SWQ7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdGhpcy5jYWNoZUNoYW5nZU5vZGVzW21vZGVsLmlkXSA9IG1vZGVsO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBzdWJtaXQoKSB7XHJcbiAgICAgICAgbGV0IGtleSwgdGVtcCwgbW9kZWxzID0gW10gYXMgQXJyYXk8Um1wR2F0ZUNoYW5nZUFyZWFJRE1vZGVsPiwgUDogYW55O1xyXG4gICAgICAgIGlmICh0aGlzLnR5cGUgPT09ICdhcmVhJykge1xyXG4gICAgICAgICAgICBmb3IgKGtleSBpbiB0aGlzLmNhY2hlQ2hhbmdlTm9kZXMpIHtcclxuICAgICAgICAgICAgICAgIHRlbXAgPSB0aGlzLmNhY2hlQ2hhbmdlTm9kZXNba2V5XTtcclxuICAgICAgICAgICAgICAgIG1vZGVscy5wdXNoKHsgaWQ6IHRlbXAuaWQsIGFyZWFJZDogdGVtcC5wYXJlbnRJZCB9IGFzIFJtcEdhdGVDaGFuZ2VBcmVhSURNb2RlbCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKG1vZGVscy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgICAgICBQID0gdGhpcy5ybXBnYXRlU2VydmljZS51cGRhdGVSbXBHYXRlQXJlYUlEKG1vZGVscyk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmxheWVyRGVjLndhcm5JbmZvKFwi5rKh5pyJ6YCJ5oup5Lu75L2V5Yy65Z+fXCIpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5jYW5jZWwoZmFsc2UpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgZm9yIChrZXkgaW4gdGhpcy5jYWNoZUNoYW5nZU5vZGVzKSB7XHJcbiAgICAgICAgICAgICAgICB0ZW1wID0gdGhpcy5jYWNoZUNoYW5nZU5vZGVzW2tleV07XHJcbiAgICAgICAgICAgICAgICBtb2RlbHMucHVzaCh7IGlkOiB0ZW1wLmlkLCBsYW1wSWQ6IHRlbXAucGFyZW50SWQsIGRldmljZVJlSWQ6IHRlbXAuZGV2aWNlUmVJZCB9IGFzIFJtcEdhdGVDaGFuZ2VBcmVhSURNb2RlbCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKG1vZGVscy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgICAgICBQID0gdGhpcy5ybXBnYXRlU2VydmljZS51cGRhdGVSbXBHYXRlTGFtcElEKG1vZGVscyk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmxheWVyRGVjLndhcm5JbmZvKFwi5rKh5pyJ6YCJ5oup5Lu75L2V56uL5p2GXCIpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5jYW5jZWwoZmFsc2UpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChQKSB7XHJcbiAgICAgICAgICAgIFAudGhlbigocmVzOiBSZXNwb25zZVJlc3VsdDxib29sZWFuPikgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKHJlcyAmJiByZXMuY29kZSA9PT0gMjAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5jYW5jZWwodHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoXCJybXBnYXRlU2VydmljZS51cGRhdGVSbXBHYXRlQXJlYUlEIGVycm9yXCIsIHJlcyk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgfVxyXG5cclxuICAgIH1cclxuICAgIGNhbmNlbChmbGFnPzogYm9vbGVhbikge1xyXG4gICAgICAgIHRoaXMuJHNjb3BlLiRlbWl0KCdkZXZpY2UuY2xvc2VQb3B1cCcsIGZsYWcpO1xyXG4gICAgfVxyXG4gICAgcHJpdmF0ZSBnZXRMZWZ0VHJlZURhdGEoKSB7XHJcbiAgICAgICAgdGhpcy5ybXBnYXRlU2VydmljZS5maW5kQWxsKCkudGhlbigocmVzOiBBcnJheTxSbXBHYXRlRXg+KSA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMuJHRpbWVvdXQoKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5sZWZ0VHJlZVBhcmFtcy50cmVlRGF0YXMgPSByZXM7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgcHJpdmF0ZSBnZXRSaWdodFRyZWVEYXRhKCkge1xyXG4gICAgICAgIGxldCBQOiBhbnk7XHJcbiAgICAgICAgaWYgKHRoaXMudHlwZSA9PT0gJ2xhbXAnKSB7XHJcbiAgICAgICAgICAgIFAgPSB0aGlzLmNvbm5lY3RUcmVlU2VydmljZS5maW5kTGFtcFRyZWVXaXRoUm1wR2F0ZSgpXHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgUCA9IHRoaXMuY29ubmVjdFRyZWVTZXJ2aWNlLmZpbmRBcmVhV2l0aFJtcGdhdGUoKVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgUC50aGVuKChkYXRhczogQXJyYXk8YW55PikgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLiR0aW1lb3V0KCgpID0+IHtcclxuICAgICAgICAgICAgICAgIHRoaXMucmlnaHRUcmVlUGFyYW1zLnRyZWVEYXRhcyA9IGRhdGFzO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9KVxyXG4gICAgfVxyXG59XHJcblxyXG5hcHAuY29udHJvbGxlcihcImJhc2VDb25maWdSbXBnYXRlUG9wdXBcIiwgUm1wZ2F0ZVBvcHVwQ29udHJvbGxlcik7Il19
